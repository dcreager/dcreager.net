<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
 
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>dcreager.net</title>
    <meta name="author" content="Douglas Creager" />

    <meta name="google-site-verification" content="7KIoYPNsfdDxIdX1QQ7SM2Nm_nyy13aRlDkzE3wzhhY" />

    
    <link rel="openid.server" href="http://openid.dcreager.net/index.php" />
    <link rel="openid.delegate" href="http://openid.dcreager.net/index.php" />
    

    <link rel="alternate" type="application/atom+xml"
          title="dcreager.net" href="/atom.xml"/>
 
    <!-- syntax highlighting CSS -->
    <link rel="stylesheet" href="/css/syntax.css" type="text/css" />

    <!-- main CSS -->
    <link rel="stylesheet" href="/css/main.css" type="text/css" />
  </head>

  <body>

    <!--
       Preload some images.  The “preload” class is set to never
       display.
      -->
    <div class="preload">
      <img src="/images/icon-pdf.png"/>
      <img src="/images/icon-pdf-shadow.png"/>
      <img src="/images/mag.png"/>
      <img src="/images/mag-shadow.png"/>
    </div>

    <div class="site">
      <div class="site_content">
        <div class="left">
          <div class="leftnav">
            <p><a href="/">Home</a></p>
<p><a href="/about/">About</a></p>
<p><a href="/archive/">Archive</a></p>
<p><a href="/publications/">Publications</a></p>

          </div>
        </div>

        <div class="site_header">
          <p class="title">dcreager.net</p>
          <p class="subtitle">A BLOG ABOUT HUGE DATA, CODING, AND MISCELLANEA</p>
        </div>

        <div class="body">
          
  

  <h1>Updating graffle-export to work with OmniGraffle 5</h1>

  <div class="postdate">
    Friday, February 05, 2010
  </div>

  <p>I recently upgraded to OmniGraffle 5, which caused my <a href='http://github.com/dcreager/graffle-export/'>graffle-export</a> script to break:</p>

<pre><code>$ graffle.sh ~/git/cwa/figures/analyst.graffle foo.pdf 
OmniGraffle Professional 5
/Users/dcreager/git/cwa/figures/analyst.graffle
./graffle.scpt: execution error: OmniGraffle Professional 5 got an error: The document cannot be exported to the &quot;pdf&quot; format. (-50)</code></pre>

<p>(This was first reported to me by Nima Talebi as <a href='http://github.com/dcreager/graffle-export/issues/issue/1'>a ticket</a> on graffle-export&#8217;s Github page.)</p>

<p>Before we can understand what error we&#8217;re seeing, a little explanation is in order. The core logic of the OmniGraffle exporter is an AppleScript. Unfortunately, AppleScripts are stored in a binary format, so if you go to the Github page, you can&#8217;t easily view the contents of the file. The important line of the script is:</p>
<div class='highlight'><pre><code class='applescript'><span class='nv'>save</span> <span class='nv'>doc</span> <span class='k'>as</span> <span class='nv'>format</span> <span class='k'>in</span> <span class='nv'>file</span> <span class='nv'>output</span>
</code></pre>
</div>
<p>This saves an OmniGraffle document (which an earlier part of the script makes sure is open) into a new output file. The <code>output</code> variable is the name of the desired output file, and is taken directly from the <em>graffle.sh</em> command line.</p>

<p>The <code>format</code> variable is what&#8217;s causing us problems. This parameter to the <code>save</code> command tells OmniGraffle what format to use for the file it&#8217;s about to save. This is how we get our export functionality; we just give it the name of one of the export formats that it supports. The value of our <code>format</code> variable comes from the optional first parameter to the <em>graffle.sh</em> script. Previously, if no value was specified, I used &#8221;<code>pdf</code>&#8221; as a default.</p>

<p>Now, there&#8217;s no real documentation that I&#8217;ve been able to find out what values are allowed for this parameter. I came across <code>pdf</code> simply by trial and error. &#8221;<code>PDF</code>&#8221; also seems to work, as does &#8221;<code>PDF
vector image</code>&#8221;, which is the text that appears in the Format entry of OmniGraffle&#8217;s Export dialog box.</p>

<p>Or, to be more accurate, I should say that these values all work <strong>in OmniGraffle 4</strong>. Once you upgrade to version 5, these values no longer seem to be valid choices for that parameter of the <code>save</code> command — hence the error message. A quick, non-exhaustive test shows that none of these variations work for EPS or SVG, either. The only one that seems to still work is PNG.</p>

<p>So, what are we to do? After looking at several other related AppleScripts on the web, it seems that the <code>as</code> parameter of the <code>save</code> command is optional. After some experimentation, it turns out that if you leave out this parameter, OmniGraffle tries to deduce the correct output format based on the extension of your output filename. So, we change our <code>save</code> command to the following:</p>
<div class='highlight'><pre><code class='applescript'><span class='k'>if</span> <span class='nv'>format</span> <span class='o'>=</span> <span class='s2'>&quot;&quot;</span> <span class='k'>then</span>
  <span class='nv'>save</span> <span class='nv'>doc</span> <span class='k'>in</span> <span class='nv'>file</span> <span class='nv'>output</span>
<span class='k'>else</span>
  <span class='nv'>save</span> <span class='nv'>doc</span> <span class='k'>as</span> <span class='nv'>format</span> <span class='k'>in</span> <span class='nv'>file</span> <span class='nv'>output</span>
<span class='k'>end</span> <span class='k'>if</span>
</code></pre>
</div>
<p>(We also have to modify the <em>graffle.sh</em> wrapper script to not use <code>pdf</code> as a default, but you can see that change <a href='http://github.com/dcreager/graffle-export/commit/b605b461a29b73ab4c21bd42b48549bd8bad8fcc'>on Github</a>.) This lets us export a PDF version of a <em>.graffle</em> file by giving an output filename ending in <em>.pdf</em>, and leaving out the format parameter.</p>

<p>I still have my old copy of OmniGraffle 4, and it looks like this trick works with that version as well. So, this is now the default behavior, regardless of which version you have installed.</p>

<p>It would be nice if there was an accurate list of what values were allowed for the <code>as</code> parameter, but we do have a working solution, at least. The only problem is if you want to export a PDF with a different extension; with this solution, you&#8217;d have to export to a <em>.pdf</em> file and then rename it to your new extension. But then again, why would you want to do that?</p>

  
  <div class="posttags">
    Tags:
    <ul>
      
      <li><a href="/tags/omnigraffle/">omnigraffle</a></li>
      
      <li><a href="/tags/papers/">papers</a></li>
      
    </ul>
  </div>
  

  <div class="postlinks">
    <a href="/2010/02/05/omnigraffle-5-export/">Permanent link</a>
    |
    <a href="/2010/02/05/omnigraffle-5-export/#disqus_thread">Comments</a>
  </div>

  
  </div>
<div class="body_separator"></div>
<div class="body">

  

  <h1>Default “scons -c” targets</h1>

  <div class="postdate">
    Friday, January 08, 2010
  </div>

  <p>As I mentioned in a <a href='/2009/12/18/make-distclean-in-scons/'>previous post</a>, the automatic “clean” target provided by SCons (<code>scons -c</code>) is very useful for cleaning out build files, without requiring much in the way of configuration. Anything that SCons generates when you run <code>scons</code> will be automatically cleaned when you run <code>scons -c</code>.</p>

<p>While useful, I&#8217;d like more control over the behavior of <code>scons -c</code>. Specifically, being a good TDD junkie, I have several test cases that I can run using <code>scons test</code>:</p>
<div class='highlight'><pre><code class='python'><span class='lineno'>1</span> <span class='n'>build_test</span> <span class='o'>=</span> <span class='n'>env</span><span class='o'>.</span><span class='n'>Program</span><span class='p'>(</span> <span class='o'>...</span> <span class='p'>)</span>
<span class='lineno'>2</span> <span class='n'>env</span><span class='o'>.</span><span class='n'>Alias</span><span class='p'>(</span><span class='s'>&quot;build-tests&quot;</span><span class='p'>,</span> <span class='n'>build_test</span><span class='p'>)</span>
<span class='lineno'>3</span> 
<span class='lineno'>4</span> <span class='n'>run_test</span> <span class='o'>=</span> <span class='n'>env</span><span class='o'>.</span><span class='n'>Alias</span><span class='p'>(</span><span class='s'>&quot;test&quot;</span><span class='p'>,</span> <span class='p'>[</span><span class='n'>build_test</span><span class='p'>],</span>
<span class='lineno'>5</span>                      <span class='p'>[</span><span class='s'>&quot;@</span><span class='si'>%s</span><span class='s'>&quot;</span> <span class='o'>%</span> <span class='n'>build_test</span><span class='p'>[</span><span class='mf'>0</span><span class='p'>]</span><span class='o'>.</span><span class='n'>abspath</span><span class='p'>])</span>
<span class='lineno'>6</span> <span class='n'>env</span><span class='o'>.</span><span class='n'>AlwaysBuild</span><span class='p'>(</span><span class='n'>run_test</span><span class='p'>)</span>
</code></pre>
</div>
<p>By setting it up this way, the test programs aren&#8217;t built by default: you have to explicitly run <code>scons build-tests</code> (if you want to build the tests but not run them) or <code>scons test</code> (if you want to build and run them). Moreover, because of SCons&#8217;s dependency tracking, I can just use <code>scons test</code> as my usual build command during my Edit-Test-Debug loop. SCons will automatically rebuild any changed source files before running the tests.</p>

<p>All of this is great. So what&#8217;s the problem? As I mentioned above, <code>scons -c</code> only cleans the build files that are created by <code>scons</code> — and since I&#8217;ve explicitly set things up so that tests aren&#8217;t <em>built</em> by default, they&#8217;ll also not be <em>cleaned</em> by default. This means that to fully clean out my build targets, I have to run two commands:</p>

<pre><code>$ scons -c
$ scons -c build-tests</code></pre>

<p>Not ideal! I&#8217;d prefer if <code>scons -c</code> cleaned everything, just like <code>make clean</code> would in the Automake world.</p>

<h2 id='the_solution'>The solution</h2>

<p>So how to fix this? First we need to understand how SCons decides what to clean when you run <code>scons -c</code>. The answer is “exactly what&#8217;s built by <code>scons</code>”. And how does SCons decide what to build when you run <code>scons</code>? That&#8217;s what the <code>Default</code> command is for.</p>

<p>For instance, I could add</p>
<div class='highlight'><pre><code class='python'><span class='lineno'>1</span> <span class='n'>env</span><span class='o'>.</span><span class='n'>Default</span><span class='p'>(</span><span class='s'>&quot;build-tests&quot;</span><span class='p'>)</span>
</code></pre>
</div>
<p>to my <em>SConstruct</em> file. This would cause all of my tests to be built by default, and by extension, to have them all cleaned by default, as well.</p>

<p>This is close, since <code>scons -c</code> now does what we want, but this means that <code>scons</code> is now building more than we would like. What we need is a way to have a different list of default targets depending on whether we&#8217;re building or cleaning. Luckily, the <code>GetOption</code> function gives us exactly that:</p>
<div class='highlight'><pre><code class='python'><span class='lineno'>1</span> <span class='k'>if</span> <span class='n'>GetOption</span><span class='p'>(</span><span class='s'>&quot;clean&quot;</span><span class='p'>):</span>
<span class='lineno'>2</span>     <span class='n'>env</span><span class='o'>.</span><span class='n'>Default</span><span class='p'>(</span><span class='s'>&quot;build-tests&quot;</span><span class='p'>)</span>
</code></pre>
</div>
<p>With this in our <em>SConstruct</em> file, the tests will be considered a default target when we&#8217;re cleaning, but not when we&#8217;re building. So now we have what we want: <code>scons</code> builds just the code, <code>scons test</code> builds and runs the tests, and <code>scons -c</code> cleans it all.</p>

  
  <div class="posttags">
    Tags:
    <ul>
      
      <li><a href="/tags/scons/">scons</a></li>
      
    </ul>
  </div>
  

  <div class="postlinks">
    <a href="/2010/01/08/default-scons-clean-targets/">Permanent link</a>
    |
    <a href="/2010/01/08/default-scons-clean-targets/#disqus_thread">Comments</a>
  </div>

  
  </div>
<div class="body_separator"></div>
<div class="body">

  

  <h1>Exporting OmniGraffle documents from the command line</h1>

  <div class="postdate">
    Tuesday, January 05, 2010
  </div>

  <p><a href='http://www.omnigroup.com/applications/OmniGraffle/'>OmniGraffle</a> is my tool of choice for creating figures for my papers. It&#8217;s biggest drawback is that it&#8217;s only available for Mac OS, which can make it cumbersome if I&#8217;m working on one of my Linux machines and need to create or modify a figure. But it&#8217;s ease-of-use and the quality of the figures it creates are hard to beat.</p>

<p>Of course, creating the figure isn&#8217;t enough — since I write my papers in LaTeX, I have to export my figures into EPS or PDF (depending on whether I&#8217;m creating a PostScript or PDF version of the paper) before I can use them in my documents. It&#8217;s easy enough to use the Export dialog to do this (keyboard shortcut: ⌥⌘E), but ideally I&#8217;d like the ability to export figures from the command line. Coupled with a good Makefile, this would let me run a simple <code>make paper</code> command, and automatically re-export any necessary figures before rebuilding the paper itself.</p>

<p>Luckily, OmniGraffle has always had rather good support for being controlled via AppleScript. The commands can be somewhat undocumented, requiring a bit of trial and error, but while entrenched in our PhD studies at Oxford, my colleague David Faitelson and I were able to whip together a script that suited our needs. I&#8217;ve recently extracted the code from our Oxford SVN repository and uploaded it to <a href='http://github.com/dcreager/graffle-export'>Github</a>.</p>

<p>To install the script, just place the <em>graffle.sh</em> and <em>graffle.scpt</em> files into some directory that&#8217;s on your <code>$PATH</code>, such as <em>/usr/local/bin</em> or <em>$HOME/bin</em>. Then just run</p>

<pre><code>$ graffle.sh «format» «graffle file» «output file»</code></pre>

<p>This will open the figure in OmniGraffle, and export it into the format you specify on the command line, saving the result into <code>«output file»</code>.</p>

<p>I&#8217;m still using version 4 of OmniGraffle, so I haven&#8217;t had a chance to verify that the script still works with version 5. If you try it, and it doesn&#8217;t, feel free to open up a ticket on the <a href='http://github.com/dcreager/graffle-export/issues'>Github site</a>.</p>

  
  <div class="posttags">
    Tags:
    <ul>
      
      <li><a href="/tags/omnigraffle/">omnigraffle</a></li>
      
      <li><a href="/tags/papers/">papers</a></li>
      
    </ul>
  </div>
  

  <div class="postlinks">
    <a href="/2010/01/05/omnigraffle-export/">Permanent link</a>
    |
    <a href="/2010/01/05/omnigraffle-export/#disqus_thread">Comments</a>
  </div>


        </div>

        

      </div>
    </div>

    <div class="footer">
      <div class="copyright">
        Copyright © 2009-2010, Douglas Creager.  All rights reserved.
      </div>
    </div>

  </body>
</html>

