<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
 
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>dcreager.net</title>
    <meta name="author" content="Douglas Creager" />

    <meta name="google-site-verification" content="7KIoYPNsfdDxIdX1QQ7SM2Nm_nyy13aRlDkzE3wzhhY" />

    
    <link rel="openid.server" href="http://openid.dcreager.net/index.php" />
    <link rel="openid.delegate" href="http://openid.dcreager.net/index.php" />
    

    <link rel="alternate" type="application/atom+xml"
          title="dcreager.net" href="/atom.xml"/>
 
    <!-- syntax highlighting CSS -->
    <link rel="stylesheet" href="/css/syntax.css" type="text/css" />

    <!-- main CSS -->
    <link rel="stylesheet" href="/css/main.css" type="text/css" />

    <!-- Cufon -->
    <script src="/js/jquery-1.4.1.min.js" type="text/javascript"></script>
    <script src="/js/cufon-yui.js" type="text/javascript"></script>
    <script src="/js/Delicious.js" type="text/javascript"></script>
    <script src="/js/Junction.js" type="text/javascript"></script>
    <script src="/js/Tagesschrift.js" type="text/javascript"></script>

    <script type="text/javascript">
      Cufon.replace('.body h1', { fontFamily: 'Delicious' });
      Cufon.replace('.body h2', { fontFamily: 'Delicious' });
      Cufon.replace('.body h3', { fontFamily: 'Delicious' });
      Cufon.replace('.body .postdate', { fontFamily: 'Junction' });
      Cufon.replace('.site_header .title', { fontFamily: 'Tagesschrift' });
      Cufon.replace('.site_header .subtitle', { fontFamily: 'Junction' });
    </script>
  </head>

  <body>

    <!--
       Preload some images.  The “preload” class is set to never
       display.
      -->
    <div class="preload">
      <img src="/images/icon-pdf.png"/>
      <img src="/images/icon-pdf-shadow.png"/>
      <img src="/images/mag.png"/>
      <img src="/images/mag-shadow.png"/>
    </div>

    <div class="site">
      <div class="site_content">
        <div class="left">
          <div class="leftnav">
            <h3><a href="/">Home</a></h3>
<h3><a href="/about/">About</a></h3>
<h3><a href="/archive/">Archive</a></h3>
<h3><a href="/publications/">Publications</a></h3>

          </div>
        </div>

        <div class="site_header">
          <h1 class="title">dcreager.net</p>
          <h2 class="subtitle">a blog about huge data, coding, and miscellanea</p>
        </div>

        <div class="content">

        <div class="body">
          
  

  <h1>Extracting setuptools version numbers from your git repository</h1>

  <div class="postdate">
    Wednesday, February 10, 2010
  </div>

  <p>Just like everyone else, we&#8217;re using <a href='http://pypi.python.org/pypi/setuptools'>setuptools</a> as the core of the build system for our Python-based projects. For the most part, this has been a painless, straightforward process. However, one lingering annoyance is that we&#8217;ve been specifying the version number directly in our <em>setup.py</em> files:</p>
<div class='highlight'><pre><code class='python'><span class='kn'>from</span> <span class='nn'>setuptools</span> <span class='kn'>import</span> <span class='n'>setup</span>

<span class='n'>setup</span><span class='p'>(</span>
    <span class='n'>name</span> <span class='o'>=</span> <span class='s'>&quot;awesomelib&quot;</span><span class='p'>,</span>
    <span class='n'>version</span> <span class='o'>=</span> <span class='s'>&quot;1.2&quot;</span><span class='p'>,</span>
    <span class='c'># ...etc</span>
<span class='p'>)</span>
</code></pre>
</div>
<p>On our maintenance branches, we get a nice <em>awesomelib-1.2.tar.gz</em> file when we run <code>python setup.py sdist</code>. On our development branch, we&#8217;ve also got the following <em>setup.cfg</em> file:</p>
<div class='highlight'><pre><code class='ini'><span class='k'>[egg_info]</span>
<span class='na'>tag_build</span> <span class='o'>=</span> <span class='s'>dev</span>
<span class='na'>tag_date</span> <span class='o'>=</span> <span class='s'>true</span>
</code></pre>
</div>
<p>That gives us tarballs like <em>awesomelib-1.2dev-20100210.tar.gz</em> on our development branch. Because we&#8217;re using the <code>dev</code> suffix, which setuptools considers to be a &#8220;prerelease&#8221;, we have to remember to increment the version number in development whenever we cut a new release. The end result is that we have a longish process for creating releases. If we want to create a new 1.3 release, we have to do the following:</p>

<ol>
<li>
<p>Create a new maintenance branch for 1.3:</p>

<pre><code>$ git checkout -b maint-1.3 master</code></pre>
</li>

<li>
<p>Update the <em>setup.cfg</em> file to remove the <code>tag_build</code> and <code>tag_date</code> entries. Commit this with a &#8220;Tagging version 1.3&#8221; commit message.</p>
</li>

<li>
<p>Back on the development branch, update <em>setup.py</em> to increment the &#8220;development version&#8221; to 1.4.</p>
</li>
</ol>

<p>Granted, this isn&#8217;t horribly difficult, but we can do better.</p>

<h2 id='calculating_the_version_automatically'>Calculating the version automatically</h2>

<p>Taking a page from the <a href='http://git.kernel.org/?p=git/git.git;a=blob;f=GIT-VERSION-GEN'><em>GIT-VERSION-GEN</em></a> script in git&#8217;s source code, we&#8217;re going to use the <code>git describe</code> command to automatically generate the version number.</p>

<p>Our logic is implemented in a new <code>get_git_version()</code> Python function, which you can call directly from your <em>setup.py</em> scripts. You can find the source code in a <a href='http://gist.github.com/300803'>Github gist</a>. Our basic strategy is:</p>

<ol>
<li>
<p>First, try to use <code>git describe</code> to create a version number.</p>
</li>

<li>
<p>If this fails, then we&#8217;re most likely not in a git working copy. Probably, someone downloaded a release tarball and unpacked it, and we&#8217;re running inside of there. In this case, <code>git describe</code> can&#8217;t give us a version number. Instead, we&#8217;re going to make sure we include a <em>RELEASE-VERSION</em> file in every tarball that we create. So, if <code>git describe</code> fails, we fall back on the contents of this file as our version number.</p>
</li>
</ol>

<h3 id='tag_names_as_version_numbers'>Tag names as version numbers</h3>

<p>One thing to notice about this strategy is that we use the output of <code>git describe</code> directly as our version number. This means that our tag names should be simple version numbers, without decoration. To create the awesomelib 1.3 release from our example, we&#8217;d just do:</p>

<pre><code>$ git tag -s 1.3</code></pre>

<p>(Note that the tag needs to be an annotated or signed tag in order to be picked up by <code>git describe</code>.)</p>

<p>On our development branch, once we&#8217;ve created new commits on top of the release point, we&#8217;ll start getting output like this from <code>git
describe</code>:</p>

<pre><code>1.3-4-g6f32</code></pre>

<p>This is a valid setuptools &#8220;postrelease&#8221; — setuptools will consider this to be a more recent version than <code>1.3</code>, which is exactly what we want. This eliminates the need to maintain different <em>setup.cfg</em> files in our development and maintenance branches.</p>

<h3 id='getting_the_version_number_of_a_distribution_tarball'>Getting the version number of a distribution tarball</h3>

<p>Another thing to notice is that we need to maintain a <em>RELEASE-VERSION</em> file, ensuring that it always contains the current version, and always including it when we create any source packages. That way, we can still get the current version number, even if we can&#8217;t get it from <code>git describe</code>.</p>

<p>To keep the <em>RELEASE-VERSION</em> file up-to-date, the <code>get_git_version()</code> function always read in the current contents of the file as its first step. If the output of <code>git describe</code> differs from what&#8217;s in the file, we update the file with the new output before returning the version.</p>

<p>This ensures that the file has the right contents, but we also have to make sure we include it in our source packages. To do this, we simply add the following line to our <em>MANIFEST.in</em> file (creating it if necessary):</p>

<pre><code>include RELEASE-VERSION</code></pre>

<p>(Note that we don&#8217;t want the <em>RELEASE-VERSION</em> file to be checked into the git repository, so we also add it to the top-level <em>.gitignore</em> file.)</p>

<h2 id='the_simpler_release_process'>The simpler release process</h2>

<p>With this script, our release process is now much simpler:</p>

<ol>
<li>
<p>Create a maintenance branch if you want to.</p>
</li>

<li>
<p>Create a signed or annotated tag, whose name is the new version number.</p>
</li>
</ol>

<p>Most importantly, no extra commits are needed, since we don&#8217;t have to edit any version numbers or maintain different <em>setup.cfg</em> files.</p>

  
  <div class="posttags">
    Tags:
    <ul>
      
      <li><a href="/tags/setuptools/">setuptools</a></li>
      
      <li><a href="/tags/python/">python</a></li>
      
      <li><a href="/tags/git/">git</a></li>
      
    </ul>
  </div>
  

  <div class="postlinks">
    <a href="/2010/02/10/setuptools-git-version-numbers/">Permanent link</a>
    |
    <a href="/2010/02/10/setuptools-git-version-numbers/#disqus_thread">Comments</a>
  </div>

  
  </div>
<div class="body_separator"></div>
<div class="body">

  

  <h1>A combinator-based parsing library for C</h1>

  <div class="postdate">
    Saturday, February 06, 2010
  </div>

  <p>Recently I&#8217;ve been working on <a href='http://github.com/dcreager/libpush/'>libpush</a>, which a new parsing library for C. It has two main features that I think will be valuable: it&#8217;s a <em>push parser</em>, which means that instead of parsing a file, stream, or single memory buffer, you supply the data (or &#8220;push&#8221; it) to the parser in chunks, as it becomes available. I plan to discuss this aspect of the parser in more detail in a later post.</p>

<p>The other main feature is that you design your parsers using <em>combinators</em>. Parser combinators are widely used in Haskell, with <a href='http://legacy.cs.uu.nl/daan/parsec.html'>Parsec</a> being the most common example. Combinator-based parsing libraries are especially nice in Haskell, because Haskell&#8217;s syntax makes them look very simple. For instance, a parser that parses matching nested parentheses is:</p>
<div class='highlight'><pre><code class='haskell'><span class='nf'>parens</span> <span class='ow'>::</span> <span class='kt'>Parser</span> <span class='nb'>()</span>
<span class='nf'>parens</span> <span class='ow'>=</span> <span class='p'>(</span><span class='n'>char</span> <span class='sc'>&#39;(&#39;</span> <span class='o'>&gt;&gt;</span> <span class='n'>parens</span> <span class='o'>&gt;&gt;</span> <span class='n'>char</span> <span class='sc'>&#39;)&#39;</span> <span class='o'>&gt;&gt;</span> <span class='n'>parens</span><span class='p'>)</span> <span class='o'>&lt;|&gt;</span> <span class='n'>return</span> <span class='nb'>()</span>
</code></pre>
</div>
<p>Here, the <code>&lt;|&gt;</code> operator represents <em>choice</em>: we try parsing the left operand, and if it fails, then we try the right operand. In our example, the right operand is the base case, which matches the empty string. The left operand parses an opening parenthesis; then recursively calls itself to match any parentheses that might be nested in the current set; then parses the closing parenthesis; and then finally tries to match a nested set that occurs after the current set.</p>

<p>When we say that this is a combinator-based parser, we mean that it&#8217;s implemented by taking <em>primitive parsers</em> — in this case <code>char &#39;(&#39;</code> and <code>return ()</code> — and combining them into more complex parsers using generic operators like <code>&gt;&gt;</code> and <code>&lt;|&gt;</code>.</p>

<p>Now, in order to be able to use combinators like this, parsers have to be first-class objects in your language. In the Haskell code, the parsers are represented by the <code>Parser ()</code> type. In most Haskell parsing libraries (including Parsec), the parser type is implemented as a <a href='http://en.wikipedia.org/wiki/Monad_%28functional_programming%29'><em>monad</em></a>. Monads have a reputation for being a horribly complex topic, but in this case, we don&#8217;t really need to learn about the underlying math. Instead, we can just view the monad as letting us do two things concisely:</p>

<ol>
<li>
<p>Parsers can return a value, which could (for instance) be the abstract syntax tree that you&#8217;re building up while parsing your language. The monadic bind operator (<code>&gt;&gt;=</code>) gives you a way to &#8220;pass&#8221; these values between parsers, if needed.</p>
</li>

<li>
<p>Simultaneously, the parser monad maintains the state of the stream you&#8217;re parsing from, keeping track of how many bytes remain, whether there&#8217;s an error condition, and possibly a nice human-readable description (line and column) of the current location.</p>
</li>
</ol>

<p>This is admittedly a lot of setup; we&#8217;ve been talking a lot about Haskell in a post that&#8217;s ostensibly describing a C library. But hopefully, this gives you a taste for the kinds of features we want to support in libpush:</p>

<ul>
<li>
<p>Parsers will be represented by a C type. In libpush this is the <code>push_callback_t</code> type.</p>
</li>

<li>
<p>There will be several primitive parsers; these will be functions that return a <code>push_callback_t</code>. The functions take take in parameters, but none of the parameters can be a <code>push_callback_t</code>. (See the <code>char</code> primitive from above; it needed to take in the particular character that is expected.)</p>
</li>

<li>
<p>There will be several combinators; these will be functions that return a <code>push_callback_t</code>, and take in other <code>push_callback_t</code>s as parameters.</p>

<p>You can see several of these primitives and combinators in action in the <a href='http://github.com/dcreager/libpush/'>libpush Github repository</a>.</p>
</li>

<li>
<p>We will use something like a monad to take care of passing values between our parsers, and for keeping track of the state of the underlying stream. I say &#8220;something like a monad&#8221;, because, unlike the Parsec library, the libpush parser type will <em>not</em> be implemented as a monad; in turns out that C is more amenable to implementing them as <a href='http://www.haskell.org/arrows/'><em>arrows</em></a>. In a later post, I&#8217;ll explain what this means in terms of writing your own parsers, or for building them up from combinators.</p>
</li>
</ul>

  
  <div class="posttags">
    Tags:
    <ul>
      
      <li><a href="/tags/libpush/">libpush</a></li>
      
      <li><a href="/tags/c/">c</a></li>
      
    </ul>
  </div>
  

  <div class="postlinks">
    <a href="/2010/02/06/libpush/">Permanent link</a>
    |
    <a href="/2010/02/06/libpush/#disqus_thread">Comments</a>
  </div>

  
  </div>
<div class="body_separator"></div>
<div class="body">

  

  <h1>Updating graffle-export to work with OmniGraffle 5</h1>

  <div class="postdate">
    Friday, February 05, 2010
  </div>

  <p>I recently upgraded to OmniGraffle 5, which caused my <a href='http://github.com/dcreager/graffle-export/'>graffle-export</a> script to break:</p>

<pre><code>$ graffle.sh ~/git/cwa/figures/analyst.graffle foo.pdf 
OmniGraffle Professional 5
/Users/dcreager/git/cwa/figures/analyst.graffle
./graffle.scpt: execution error: OmniGraffle Professional 5 got an error: The document cannot be exported to the &quot;pdf&quot; format. (-50)</code></pre>

<p>(This was first reported to me by Nima Talebi as <a href='http://github.com/dcreager/graffle-export/issues/issue/1'>a ticket</a> on graffle-export&#8217;s Github page.)</p>

<p>Before we can understand what error we&#8217;re seeing, a little explanation is in order. The core logic of the OmniGraffle exporter is an AppleScript. Unfortunately, AppleScripts are stored in a binary format, so if you go to the Github page, you can&#8217;t easily view the contents of the file. The important line of the script is:</p>
<div class='highlight'><pre><code class='applescript'><span class='nv'>save</span> <span class='nv'>doc</span> <span class='k'>as</span> <span class='nv'>format</span> <span class='k'>in</span> <span class='nv'>file</span> <span class='nv'>output</span>
</code></pre>
</div>
<p>This saves an OmniGraffle document (which an earlier part of the script makes sure is open) into a new output file. The <code>output</code> variable is the name of the desired output file, and is taken directly from the <em>graffle.sh</em> command line.</p>

<p>The <code>format</code> variable is what&#8217;s causing us problems. This parameter to the <code>save</code> command tells OmniGraffle what format to use for the file it&#8217;s about to save. This is how we get our export functionality; we just give it the name of one of the export formats that it supports. The value of our <code>format</code> variable comes from the optional first parameter to the <em>graffle.sh</em> script. Previously, if no value was specified, I used &#8221;<code>pdf</code>&#8221; as a default.</p>

<p>Now, there&#8217;s no real documentation that I&#8217;ve been able to find out what values are allowed for this parameter. I came across <code>pdf</code> simply by trial and error. &#8221;<code>PDF</code>&#8221; also seems to work, as does &#8221;<code>PDF
vector image</code>&#8221;, which is the text that appears in the Format entry of OmniGraffle&#8217;s Export dialog box.</p>

<p>Or, to be more accurate, I should say that these values all work <strong>in OmniGraffle 4</strong>. Once you upgrade to version 5, these values no longer seem to be valid choices for that parameter of the <code>save</code> command — hence the error message. A quick, non-exhaustive test shows that none of these variations work for EPS or SVG, either. The only one that seems to still work is PNG.</p>

<p>So, what are we to do? After looking at several other related AppleScripts on the web, it seems that the <code>as</code> parameter of the <code>save</code> command is optional. After some experimentation, it turns out that if you leave out this parameter, OmniGraffle tries to deduce the correct output format based on the extension of your output filename. So, we change our <code>save</code> command to the following:</p>
<div class='highlight'><pre><code class='applescript'><span class='k'>if</span> <span class='nv'>format</span> <span class='o'>=</span> <span class='s2'>&quot;&quot;</span> <span class='k'>then</span>
  <span class='nv'>save</span> <span class='nv'>doc</span> <span class='k'>in</span> <span class='nv'>file</span> <span class='nv'>output</span>
<span class='k'>else</span>
  <span class='nv'>save</span> <span class='nv'>doc</span> <span class='k'>as</span> <span class='nv'>format</span> <span class='k'>in</span> <span class='nv'>file</span> <span class='nv'>output</span>
<span class='k'>end</span> <span class='k'>if</span>
</code></pre>
</div>
<p>(We also have to modify the <em>graffle.sh</em> wrapper script to not use <code>pdf</code> as a default, but you can see that change <a href='http://github.com/dcreager/graffle-export/commit/b605b461a29b73ab4c21bd42b48549bd8bad8fcc'>on Github</a>.) This lets us export a PDF version of a <em>.graffle</em> file by giving an output filename ending in <em>.pdf</em>, and leaving out the format parameter.</p>

<p>I still have my old copy of OmniGraffle 4, and it looks like this trick works with that version as well. So, this is now the default behavior, regardless of which version you have installed.</p>

<p>It would be nice if there was an accurate list of what values were allowed for the <code>as</code> parameter, but we do have a working solution, at least. The only problem is if you want to export a PDF with a different extension; with this solution, you&#8217;d have to export to a <em>.pdf</em> file and then rename it to your new extension. But then again, why would you want to do that?</p>

  
  <div class="posttags">
    Tags:
    <ul>
      
      <li><a href="/tags/omnigraffle/">omnigraffle</a></li>
      
      <li><a href="/tags/papers/">papers</a></li>
      
    </ul>
  </div>
  

  <div class="postlinks">
    <a href="/2010/02/05/omnigraffle-5-export/">Permanent link</a>
    |
    <a href="/2010/02/05/omnigraffle-5-export/#disqus_thread">Comments</a>
  </div>


        </div>

        

        </div>

      </div>
    </div>

    <div class="footer">
      <div class="copyright">
        Copyright © 2009-2010, Douglas Creager.  All rights reserved.
      </div>
    </div>

    <script type="text/javascript"> Cufon.now(); </script>
  </body>
</html>

