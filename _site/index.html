<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
 
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>dcreager.net</title>
    <meta name="author" content="Douglas Creager" />

    <meta name="google-site-verification" content="7KIoYPNsfdDxIdX1QQ7SM2Nm_nyy13aRlDkzE3wzhhY" />

    
    <link rel="openid.server" href="http://openid.dcreager.net/index.php" />
    <link rel="openid.delegate" href="http://openid.dcreager.net/index.php" />
    

    <link rel="alternate" type="application/atom+xml"
          title="dcreager.net" href="/atom.xml"/>
 
    <!-- syntax highlighting CSS -->
    <link rel="stylesheet" href="/css/syntax.css" type="text/css" />

    <!-- main CSS -->
    <link rel="stylesheet" href="/css/main.css" type="text/css" />

    <!-- Cufon -->
    <script src="/js/jquery-1.4.1.min.js" type="text/javascript"></script>
    <script src="/js/cufon-yui.js" type="text/javascript"></script>
    <script src="/js/Delicious.js" type="text/javascript"></script>
    <script src="/js/Junction.js" type="text/javascript"></script>
    <script src="/js/Tagesschrift.js" type="text/javascript"></script>

    <script type="text/javascript">
      Cufon.replace('.body h1', { fontFamily: 'Delicious' });
      Cufon.replace('.body h2', { fontFamily: 'Delicious' });
      Cufon.replace('.body h3', { fontFamily: 'Delicious' });
      Cufon.replace('.body .postdate', { fontFamily: 'Junction' });
      Cufon.replace('.site_header .title', { fontFamily: 'Tagesschrift' });
      Cufon.replace('.site_header .subtitle', { fontFamily: 'Junction' });
    </script>
  </head>

  <body>

    <!--
       Preload some images.  The “preload” class is set to never
       display.
      -->
    <div class="preload">
      <img src="/images/icon-pdf.png"/>
      <img src="/images/icon-pdf-shadow.png"/>
      <img src="/images/mag.png"/>
      <img src="/images/mag-shadow.png"/>
    </div>

    <div class="site">
      <div class="site_content">
        <div class="left">
          <div class="leftnav">
            <h3><a href="/">Home</a></h3>
<h3><a href="/about/">About</a></h3>
<h3><a href="/archive/">Archive</a></h3>
<h3><a href="/publications/">Publications</a></h3>

          </div>
        </div>

        <div class="site_header">
          <h1 class="title">dcreager.net</p>
          <h2 class="subtitle">a blog about huge data, coding, and miscellanea</p>
        </div>

        <div class="content">

        <div class="body">
          
  

  <h1>Parser callbacks in libpush, Part 1 — Streams</h1>

  <div class="postdate">
    Thursday, February 25, 2010
  </div>

  <p>This post is the first in a series that describes the <code>push_callback_t</code> type in the <a href='http://github.com/dcreager/libpush/'>libpush</a> library. In these posts, we&#8217;ll walk through a couple of possible ways to implement callbacks under the covers. At each stage, we&#8217;ll encounter problems with the current design. Fixing these problems should lead closer us to the actual implementation in libpush, and along the way, we&#8217;ll gain a good understanding of how our design decisions affect the performance and usability of the library.</p>

<p>The <code>push_callback_t</code> type is used to define <em>parser callbacks</em>, which are the basic unit of parsing in libpush. Callbacks are pretty simple: they take in an <em>input value</em>, read some data from the <em>input stream</em>, and produce an <em>output value</em>. (The fact that callbacks take in an input value, in addition to reading from the input stream, is what makes them <a href='http://www.haskell.org/arrows/'><em>arrows</em></a> instead of <a href='http://en.wikipedia.org/wiki/Monad_%28functional_programming%29'><em>monads</em></a> — but that&#8217;s a story for a later post).</p>

<h2 id='first_attempt_callbacks_as_functions'>First attempt: Callbacks as functions</h2>

<p>Now, with this simple structure, we might try to implement callbacks as regular C functions. For instance, we could use something like the following to read in a single 32-bit integer:</p>
<div class='highlight'><pre><code class='c'><span class='cp'>#include &lt;stdbool.h&gt;</span>
<span class='cp'>#include &lt;stdint.h&gt;</span>
<span class='cp'>#include &lt;stdio.h&gt;</span>

<span class='n'>bool</span>
<span class='nf'>parse_uint32</span><span class='p'>(</span><span class='kt'>void</span> <span class='o'>*</span><span class='n'>input</span><span class='p'>,</span> <span class='kt'>uint32_t</span> <span class='o'>*</span><span class='n'>output</span><span class='p'>,</span> <span class='kt'>FILE</span> <span class='o'>*</span><span class='n'>stream</span><span class='p'>)</span>
<span class='p'>{</span>
    <span class='kt'>size_t</span>  <span class='n'>num_read</span><span class='p'>;</span>

    <span class='n'>num_read</span> <span class='o'>=</span> <span class='n'>fread</span><span class='p'>(</span><span class='n'>output</span><span class='p'>,</span> <span class='k'>sizeof</span><span class='p'>(</span><span class='kt'>uint32_t</span><span class='p'>),</span> <span class='mi'>1</span><span class='p'>,</span> <span class='n'>stream</span><span class='p'>);</span>
    <span class='k'>return</span> <span class='p'>(</span><span class='n'>num_read</span> <span class='o'>==</span> <span class='mi'>1</span><span class='p'>);</span>
<span class='p'>}</span>
</code></pre>
</div>
<p>This callback ignores its input value, reads in four bytes from the input stream, and uses that to output a <code>uint32_t</code> value. The return value of the function is a boolean, indicating whether the parse was successful or not. This lets us handle <em>parse errors</em> — for instance, if there are only three bytes left in the stream, we can&#8217;t read in a full integer. We return <code>false</code> to indicate this error condition.</p>

<p>We&#8217;ve ignored some details here that aren&#8217;t important for this example — for instance, we don&#8217;t worry about the endianness of the integer, nor do we worry about how the space for the output result is allocated. We just assume that someone will pass in a pointer to a <code>uint32_t</code> variable, and our callback function will store its output value there.</p>

<h2 id='drawbacks'>Drawbacks</h2>

<p>This approach works fine for simple cases, but unfortunately has two drawbacks. First, we&#8217;re limited to parsing from <code>FILE</code> streams. Any real input source will probably be available as a stream, so this might not seem like a huge problem — though it does rule out parsing from a memory buffer, unless you use a non-portable function like <code>fmemopen</code>.</p>

<p>The second, more important, problem is that the parser callback has full control over when and how much to read from the stream. In this example, we try to read in the full four bytes for the <code>uint32_t</code> output value. However, there might not be four bytes available in the stream. If this is because we&#8217;re at the end of a file, then we should treat this as a parse error. If we&#8217;re reading from a network socket, though, another chunk of data might arrive if we wait for a bit.</p>

<p>We could add logic to the callback to read from the stream repeatedly until we got enough data, but then we&#8217;ll start <em>blocking</em> — so that we can distinguish between &#8220;there&#8217;s no more data here <em>yet</em>&#8221; from &#8220;there&#8217;s no more data coming <em>at all</em>&#8221;.</p>

<p>All of this is bad news. First of all, this extra I/O logic is starting to get rather big, and we don&#8217;t want each and every callback to have to include it. And second, we don&#8217;t want the rest of our program to be held hostage by the callback — it should be up to our I/O code to decide whether it&#8217;s okay to block waiting for more input, or whether to whip up a nice <code>select</code> loop of some kind to read things more efficiently.</p>

<p>In the next post, we&#8217;ll describe <em>iteratees</em>, which give us this capability.</p>

  
  <div class="posttags">
    Tags:
    <ul>
      
      <li><a href="/tags/libpush/">libpush</a></li>
      
      <li><a href="/tags/c/">c</a></li>
      
    </ul>
  </div>
  

  <div class="postlinks">
    <a href="/2010/02/25/libpush-callbacks-part-1/">Permanent link</a>
    |
    <a href="/2010/02/25/libpush-callbacks-part-1/#disqus_thread">Comments</a>
  </div>

  
  </div>
<div class="body_separator"></div>
<div class="body">

  

  <h1>Using LLVM's link-time optimization on Ubuntu Karmic</h1>

  <div class="postdate">
    Wednesday, February 17, 2010
  </div>

  <p>While playing around with <a href='http://github.com/dcreager/libpush'>libpush</a> on my MacBook, I was pleasantly surprised to see a huge performance increase when I used the link-time optimization (LTO) feature of the LLVM GCC front end. (It&#8217;s really quite nifty; the new <a href='http://github.com/mxcl/homebrew'>Homebrew package manager</a> uses it by default when compiling packages.) On MacOS, using LTO is as simple as using <code>llvm-gcc</code> as your C compiler (or <code>llvm-g++</code> if you&#8217;re compiling C++), and passing in <code>-O4</code> as your optimization flag. I use SCons as my builder, so this turns into:</p>

<pre><code>$ scons CC=llvm-gcc CCFLAGS=-O4</code></pre>

<p>This will cause GCC to output LLVM bytecode into the <em>.o</em> output files, and to perform whole-program optimizations during each linking phase. I was able to see a big performance win simply from the linker being able to inline in copies of small functions that live in “other” compilation units.</p>

<h2 id='good_news_and_bad_news'>Good news and bad news</h2>

<p>Intrigued by the results, I wanted to try the same thing on my Linux boxes, which are running Ubuntu Karmic. On the Mac, Apple has made sure to include support for LLVM in all of the standard Xcode build tools. On Linux, you don&#8217;t get this by default right now — though GCC is implementing their own LTO project, which is starting to bear fruit. Part of this is a new “<code>gold</code>” linker, which supports a plugin architecture. How is this useful to us? Well, LLVM already has a <a href='http://llvm.org/docs/GoldPlugin.html'>plugin</a> for the new linker, so with everything installed correctly, getting LTO through LLVM on Linux can be just as simple as it was on the Mac.</p>

<p>Unfortunately, these new tools have only partially made it into the Ubuntu package tree. You can get the new <code>gold</code> linker by installing the <code>binutils-gold</code> package, and you can get most of the LLVM pieces by installing the <code>llvm</code> and <code>llvm-gcc-4.2</code> packages. Unfortunately, this doesn&#8217;t include the LLVM <code>gold</code> plugin or the new <code>clang</code> C/C++ compiler front-end. Things look promising for these features being in the new Lucid packages — which could even lead to a Karmic backport — but for now, if we want the <code>gold</code> plugin, we have to compile ourselves.</p>

<h2 id='getting_the_prerequisites'>Getting the prerequisites</h2>

<p>As mentioned on the LLVM <a href='http://llvm.org/docs/GoldPlugin.html'>linker plugin page</a>, you need to have the <code>binutils</code> source lying around somewhere if you want to compile the plugin, since the LLVM source needs to read in <code>binutils</code>&#8217;s <em>plugin-api.h</em> file. The easiest way for us to get the <code>binutils</code> source is using APT:</p>

<pre><code>$ mkdir -p $HOME/deb
$ cd $HOME/deb
$ apt-get source binutils</code></pre>

<p>This will place an unpacked copy of the <code>binutils</code> source into <em>$HOME/deb/binutils-2.20</em> for you.</p>

<p>We can also go ahead and install the <code>gold</code> linker:</p>

<pre><code>$ sudo apt-get install binutils-gold</code></pre>

<p>You&#8217;ll also need to make sure you&#8217;ve got the basic compilation tools installed (though if you&#8217;re at the point where you&#8217;re trying to play around with LTO, I&#8217;ve got to assume you&#8217;ve already taken care of this&#8230;):</p>

<pre><code>$ sudo apt-get install build-essential</code></pre>

<p>Finally, my main Linux box is 64-bit, so I need to install multilib support before we can compile the LLVM GCC front end:</p>

<pre><code>$ sudo apt-get install gcc-multilib</code></pre>

<h2 id='compiling_llvm'>Compiling LLVM</h2>

<p>With all of the prerequisites installed, we can download and unpack LLVM:</p>

<pre><code>$ mkdir -p $HOME/tmp
$ cd $HOME/tmp
$ wget http://llvm.org/releases/2.6/llvm-2.6.tar.gz
$ wget http://llvm.org/releases/2.6/clang-2.6.tar.gz

$ tar xzvf llvm-2.6.tar.gz
$ tar xzvf clang-2.6.tar.gz</code></pre>

<p><code>clang</code> is distributed as a separate download, but we actually want to place it into the main LLVM directory; the LLVM build scripts will find it and build it automatically:</p>

<pre><code>$ mv clang-2.6 llvm-2.6/tools/clang</code></pre>

<p>At this point we can do the usual compilation steps:</p>

<pre><code>$ cd llvm-2.6
$ ./configure \
    --with-binutils-include=$HOME/deb/binutils-2.20/include \
    --enable-optimized \
    --prefix=/usr/local
$ make
$ sudo make install
$ sudo ldconfig</code></pre>

<p>Notice how we&#8217;re going to install everything into <em>/usr/local</em>, so as not to step on the toes of the package manager. This means we have to run <code>ldconfig</code> so that the system linker knows about the new libraries we just put in <em>/usr/local/lib</em>.</p>

<h2 id='compiling_llvmgcc'>Compiling LLVM-GCC</h2>

<p>At this point, we have the <code>gold</code> linker installed, and have a copy of LLVM that includes its <code>gold</code> plugin. Ideally, we could start compiling with <code>clang</code> and get LTO, but it doesn&#8217;t seem like there&#8217;s currently a way to have <code>clang</code> pass in the necessary <code>--plugin</code> option to the linker. So, all we need now is the GCC front end.</p>

<p>As before, we start by downloading and unpacking:</p>

<pre><code>$ cd $HOME/tmp
$ wget http://llvm.org/releases/2.6/llvm-gcc-4.2-2.6.source.tar.gz
$ tar xzvf llvm-gcc-4.2-2.6.source.tar.gz</code></pre>

<p>The <em>README.LLVM</em> file in the source tree gives more detail on the options you have available; for me, the following worked:</p>

<pre><code>$ mkdir -p $HOME/tmp/obj
$ cd $HOME/tmp/obj
$ ../llvm-gcc-4.2-2.6.source/configure \
    --prefix=/usr/local \
    --program-prefix=llvm- \
    --enable-llvm=$HOME/tmp/llvm-2.6 \
    --enable-languages=c,c++
$ make
$ sudo make install
$ sudo ldconfig</code></pre>

<p>The only interesting wrinkle is that we have to do an out-of-source build — the object files will end up in the <em>$HOME/tmp/obj</em> directory, rather than being created directly in the unpacked source directory.</p>

<p>As this point we&#8217;re nearly there; we have <code>llvm-gcc</code> installed, but its <code>-use-gold-plugin</code> option won&#8217;t work just yet. If you look closely at one sentence on the <a href='http://llvm.org/docs/GoldPlugin.html'>LLVM plugin page</a>, you&#8217;ll see that the option “looks for the <code>gold</code> plugin in the same directories as it looks for <code>cc1</code>”. The LLVM GCC package installed the <code>cc1</code> program into the <em>/usr/local/libexec/gcc/x86_64-unknown-linux-gnu/4.2.1</em> directory. (The <em>x86_64</em> will be different if you&#8217;re on a different architecture.) However, the LLVM plugin is in <em>/usr/local/lib</em>. If you try to use the <code>-use-gold-plugin</code> parameter, you&#8217;ll get the following error message:</p>

<pre><code>$ llvm-gcc -use-gold-plugin \
    -o foo.o -c -O4 -g -Wall -Werror foo.c
llvm-gcc: -use-gold-plugin, but libLLVMgold.so not found.</code></pre>

<p>Not good. The solution (which is admittedly a bit of a hack) is to copy the plugin into the directory that <code>llvm-gcc</code> expects to find it in:</p>

<pre><code>$ sudo cp /usr/local/lib/libLLVMgold.so \
    /usr/local/libexec/gcc/x86_64-unknown-linux-gnu/4.2.1</code></pre>

<h2 id='using_your_new_toy'>Using your new toy</h2>

<p>Now that we&#8217;ve got all of the pieces installed, you can create libraries and executables that are optimized at link time. The “Quickstart” section at the end of the <a href='http://llvm.org/docs/GoldPlugin.html'>LLVM plugin page</a> gives you the outline. I use SCons as my build tool, so I have to run the following:</p>

<pre><code>$ scons \
    CC=&quot;llvm-gcc -use-gold-plugin&quot; \
    AR=&quot;ar --plugin libLLVMgold.so&quot; \
    RANLIB=/bin/true \
    CCFLAGS=-O4</code></pre>

<p>This is slightly more than what&#8217;s needed on the Mac, but all in all, not bad. Enjoy!</p>

  
  <div class="posttags">
    Tags:
    <ul>
      
      <li><a href="/tags/ubuntu/">ubuntu</a></li>
      
      <li><a href="/tags/llvm/">llvm</a></li>
      
    </ul>
  </div>
  

  <div class="postlinks">
    <a href="/2010/02/17/llvm-lto-karmic/">Permanent link</a>
    |
    <a href="/2010/02/17/llvm-lto-karmic/#disqus_thread">Comments</a>
  </div>

  
  </div>
<div class="body_separator"></div>
<div class="body">

  

  <h1>Extracting setuptools version numbers from your git repository</h1>

  <div class="postdate">
    Wednesday, February 10, 2010
  </div>

  <p>Just like everyone else, we&#8217;re using <a href='http://pypi.python.org/pypi/setuptools'>setuptools</a> as the core of the build system for our Python-based projects. For the most part, this has been a painless, straightforward process. However, one lingering annoyance is that we&#8217;ve been specifying the version number directly in our <em>setup.py</em> files:</p>
<div class='highlight'><pre><code class='python'><span class='kn'>from</span> <span class='nn'>setuptools</span> <span class='kn'>import</span> <span class='n'>setup</span>

<span class='n'>setup</span><span class='p'>(</span>
    <span class='n'>name</span> <span class='o'>=</span> <span class='s'>&quot;awesomelib&quot;</span><span class='p'>,</span>
    <span class='n'>version</span> <span class='o'>=</span> <span class='s'>&quot;1.2&quot;</span><span class='p'>,</span>
    <span class='c'># ...etc</span>
<span class='p'>)</span>
</code></pre>
</div>
<p>On our maintenance branches, we get a nice <em>awesomelib-1.2.tar.gz</em> file when we run <code>python setup.py sdist</code>. On our development branch, we&#8217;ve also got the following <em>setup.cfg</em> file:</p>
<div class='highlight'><pre><code class='ini'><span class='k'>[egg_info]</span>
<span class='na'>tag_build</span> <span class='o'>=</span> <span class='s'>dev</span>
<span class='na'>tag_date</span> <span class='o'>=</span> <span class='s'>true</span>
</code></pre>
</div>
<p>That gives us tarballs like <em>awesomelib-1.2dev-20100210.tar.gz</em> on our development branch. Because we&#8217;re using the <code>dev</code> suffix, which setuptools considers to be a &#8220;prerelease&#8221;, we have to remember to increment the version number in development whenever we cut a new release. The end result is that we have a longish process for creating releases. If we want to create a new 1.3 release, we have to do the following:</p>

<ol>
<li>
<p>Create a new maintenance branch for 1.3:</p>

<pre><code>$ git checkout -b maint-1.3 master</code></pre>
</li>

<li>
<p>Update the <em>setup.cfg</em> file to remove the <code>tag_build</code> and <code>tag_date</code> entries. Commit this with a &#8220;Tagging version 1.3&#8221; commit message.</p>
</li>

<li>
<p>Back on the development branch, update <em>setup.py</em> to increment the &#8220;development version&#8221; to 1.4.</p>
</li>
</ol>

<p>Granted, this isn&#8217;t horribly difficult, but we can do better.</p>

<h2 id='calculating_the_version_automatically'>Calculating the version automatically</h2>

<p>Taking a page from the <a href='http://git.kernel.org/?p=git/git.git;a=blob;f=GIT-VERSION-GEN'><em>GIT-VERSION-GEN</em></a> script in git&#8217;s source code, we&#8217;re going to use the <code>git describe</code> command to automatically generate the version number.</p>

<p>Our logic is implemented in a new <code>get_git_version()</code> Python function, which you can call directly from your <em>setup.py</em> scripts. You can find the source code in a <a href='http://gist.github.com/300803'>Github gist</a>. Our basic strategy is:</p>

<ol>
<li>
<p>First, try to use <code>git describe</code> to create a version number.</p>
</li>

<li>
<p>If this fails, then we&#8217;re most likely not in a git working copy. Probably, someone downloaded a release tarball and unpacked it, and we&#8217;re running inside of there. In this case, <code>git describe</code> can&#8217;t give us a version number. Instead, we&#8217;re going to make sure we include a <em>RELEASE-VERSION</em> file in every tarball that we create. So, if <code>git describe</code> fails, we fall back on the contents of this file as our version number.</p>
</li>
</ol>

<h3 id='tag_names_as_version_numbers'>Tag names as version numbers</h3>

<p>One thing to notice about this strategy is that we use the output of <code>git describe</code> directly as our version number. This means that our tag names should be simple version numbers, without decoration. To create the awesomelib 1.3 release from our example, we&#8217;d just do:</p>

<pre><code>$ git tag -s 1.3</code></pre>

<p>(Note that the tag needs to be an annotated or signed tag in order to be picked up by <code>git describe</code>.)</p>

<p>On our development branch, once we&#8217;ve created new commits on top of the release point, we&#8217;ll start getting output like this from <code>git
describe</code>:</p>

<pre><code>1.3-4-g6f32</code></pre>

<p>This is a valid setuptools &#8220;postrelease&#8221; — setuptools will consider this to be a more recent version than <code>1.3</code>, which is exactly what we want. This eliminates the need to maintain different <em>setup.cfg</em> files in our development and maintenance branches.</p>

<h3 id='getting_the_version_number_of_a_distribution_tarball'>Getting the version number of a distribution tarball</h3>

<p>Another thing to notice is that we need to maintain a <em>RELEASE-VERSION</em> file, ensuring that it always contains the current version, and always including it when we create any source packages. That way, we can still get the current version number, even if we can&#8217;t get it from <code>git describe</code>.</p>

<p>To keep the <em>RELEASE-VERSION</em> file up-to-date, the <code>get_git_version()</code> function always read in the current contents of the file as its first step. If the output of <code>git describe</code> differs from what&#8217;s in the file, we update the file with the new output before returning the version.</p>

<p>This ensures that the file has the right contents, but we also have to make sure we include it in our source packages. To do this, we simply add the following line to our <em>MANIFEST.in</em> file (creating it if necessary):</p>

<pre><code>include RELEASE-VERSION</code></pre>

<p>(Note that we don&#8217;t want the <em>RELEASE-VERSION</em> file to be checked into the git repository, so we also add it to the top-level <em>.gitignore</em> file.)</p>

<h2 id='the_simpler_release_process'>The simpler release process</h2>

<p>With this script, our release process is now much simpler:</p>

<ol>
<li>
<p>Create a maintenance branch if you want to.</p>
</li>

<li>
<p>Create a signed or annotated tag, whose name is the new version number.</p>
</li>
</ol>

<p>Most importantly, no extra commits are needed, since we don&#8217;t have to edit any version numbers or maintain different <em>setup.cfg</em> files.</p>

  
  <div class="posttags">
    Tags:
    <ul>
      
      <li><a href="/tags/setuptools/">setuptools</a></li>
      
      <li><a href="/tags/python/">python</a></li>
      
      <li><a href="/tags/git/">git</a></li>
      
    </ul>
  </div>
  

  <div class="postlinks">
    <a href="/2010/02/10/setuptools-git-version-numbers/">Permanent link</a>
    |
    <a href="/2010/02/10/setuptools-git-version-numbers/#disqus_thread">Comments</a>
  </div>


        </div>

        <script type="text/javascript"> Cufon.now(); </script>

        

        </div>

      </div>
    </div>

    <div class="footer">
      <div class="copyright">
        Copyright © 2009-2010, Douglas Creager.  All rights reserved.
      </div>
    </div>
  </body>
</html>

