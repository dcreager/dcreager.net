<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
 
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>Simulating “make distclean” in SCons</title>
    <meta name="author" content="Douglas Creager" />

    

    <link rel="alternate" type="application/atom+xml"
          title="dcreager.net" href="/atom.xml"/>
 
    <!-- syntax highlighting CSS -->
    <link rel="stylesheet" href="/css/syntax.css" type="text/css" />

    <!-- main CSS -->
    <link rel="stylesheet" href="/css/main.css" type="text/css" />
  </head>

  <body>

    <!--
       Preload some images.  The “preload” class is set to never
       display.
      -->
    <div class="preload">
      <img src="/images/icon-pdf.png"/>
      <img src="/images/icon-pdf-shadow.png"/>
      <img src="/images/mag.png"/>
      <img src="/images/mag-shadow.png"/>
    </div>

    <div class="site">
      <div class="site_content">
        <div class="left">
          <div class="leftnav">
            <p><a href="/">Home</a></p>
<p><a href="/about/">About</a></p>
<p><a href="/archive/">Archive</a></p>
<p><a href="/publications/">Publications</a></p>

          </div>
        </div>

        <div class="site_header">
          <p class="title">dcreager.net</p>
          <p class="subtitle">A BLOG ABOUT HUGE DATA, CODING, AND MISCELLANEA</p>
        </div>

        <div class="body">
          <h1>Simulating “make distclean” in SCons</h1>

<div class="postdate">
  Friday, December 18, 2009
</div>

<div class="post">
  <p>SCons provides an automatic “clean” target out of the box — just run <code>scons -c</code>, and SCons will delete all of the objects that it knows how to build. This is a very useful feature; however, there are two main missing features that I want to add to my build scripts. First, I want to be able to delete all of the temporary files SCons uses, such as its configuration cache and any files I use to store variable values. These aren&#8217;t included in the default list of the files to clean up. Second, I want more control over which items are deleted by default, when you specify <code>scons -c</code> without any targets. I&#8217;ll describe my solution to the first problem in this post. I&#8217;ll write up the second problem in another post.</p>

<h2 id='deleting_sconss_temporary_files'>Deleting SCons&#8217;s temporary files</h2>

<p>This feature is akin to the <code>make distclean</code> target that Automake puts into the Makefiles that it generates. This differs from <code>make clean</code>; <code>make clean</code> is intended to delete all of the build products, but leave behind the results of the <code>configure</code> step, whereas <code>make
distclean</code> is supposed delete <em>everything</em>, returning the source tree to the same state as when you&#8217;d just unpacked the tarball.</p>

<p>The <code>scons -c</code> command is analogous to <code>make clean</code>, and requires no setup. It will automatically delete any of the build products that are created by running <code>scons</code>. There are several cache files that SCons creates, however, and it would be nice to have an equivalent to <code>make distclean</code>. This is especially useful when developing a new <code>Configuration</code> check, for instance — if you make a change to the test, you want to be able to (easily) force SCons to ignore any cached results, and try all of the tests again.</p>

<p>This is actually fairly easy to set up, assuming you know the list of temporary files that SCons will create. You can add the following rule to your top-level <em>SConstruct</em> file:</p>
<div class='highlight'><pre><code class='python'><span class='lineno'>1</span> <span class='n'>env</span><span class='o'>.</span><span class='n'>Clean</span><span class='p'>(</span><span class='s'>&quot;distclean&quot;</span><span class='p'>,</span>
<span class='lineno'>2</span>           <span class='p'>[</span>
<span class='lineno'>3</span>            <span class='s'>&quot;.sconsign.dblite&quot;</span><span class='p'>,</span>
<span class='lineno'>4</span>            <span class='s'>&quot;.sconf_temp&quot;</span><span class='p'>,</span>
<span class='lineno'>5</span>            <span class='s'>&quot;config.log&quot;</span><span class='p'>,</span>
<span class='lineno'>6</span>           <span class='p'>])</span>
</code></pre>
</div>
<p>As far as I can tell, these three files are always created by SCons. To delete these files, you simply run <code>scons -c distclean</code>. Because we&#8217;ve defined the target using <code>Clean</code>, it will only be run when you pass in the <code>-c</code> option to <code>scons</code>.</p>

<p>Since we&#8217;re putting together the file list manually, you should make sure to add any additional cache files that your SCons scripts use. For instance, I&#8217;m using some <code>Variable</code> options, which I store into a file called <em>.scons.vars</em>. (This means that the user doesn&#8217;t have to type them in with every invocation of <code>scons</code>.) By using these variables, I have to add another entry to the <code>distclean</code> target:</p>
<div class='highlight'><pre><code class='python'><span class='lineno'>1</span> <span class='nb'>vars</span> <span class='o'>=</span> <span class='n'>Variables</span><span class='p'>(</span><span class='s'>&#39;.scons.vars&#39;</span><span class='p'>,</span> <span class='n'>ARGUMENTS</span><span class='p'>)</span>
<span class='lineno'>2</span> <span class='c'># ...define a bunch of variables</span>
<span class='lineno'>3</span> <span class='nb'>vars</span><span class='o'>.</span><span class='n'>Update</span><span class='p'>(</span><span class='n'>env</span><span class='p'>)</span>
<span class='lineno'>4</span> <span class='nb'>vars</span><span class='o'>.</span><span class='n'>Save</span><span class='p'>(</span><span class='s'>&quot;.scons.vars&quot;</span><span class='p'>,</span> <span class='n'>env</span><span class='p'>)</span>
<span class='lineno'>5</span> 
<span class='lineno'>6</span> <span class='n'>env</span><span class='o'>.</span><span class='n'>Clean</span><span class='p'>(</span><span class='s'>&quot;distclean&quot;</span><span class='p'>,</span> <span class='p'>[</span><span class='s'>&quot;.scons.vars&quot;</span><span class='p'>])</span>
</code></pre>
</div>
<p>Note how, just like with any SCons target, I can define the <code>distclean</code> target multiple times. SCons will take care of merging them into a single action, deleting all of the specified files when you run <code>scons -c distclean</code>.</p>
</div>


<div class="posttags">
  Tags:
  <ul>
    
    <li><a href="/tags/scons/">scons</a></li>
    
  </ul>
</div>


        </div>

        

        <div class="body_separator"></div>

        <div class="body">
          <div id="disqus_thread"></div>

          <script type="text/javascript">
            var disqus_title = "Simulating “make distclean” in SCons";
            var disqus_url = "http://dcreager.net/2009/12/18/make-distclean-in-scons/";
          </script>

          <script
             type="text/javascript"
             src="http://disqus.com/forums/dcreager/embed.js">
          </script>
          <noscript>
            <a href="http://dcreager.disqus.com/?url=ref">View the discussion thread.</a>
          </noscript>

          <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
        </div>

        

      </div>
    </div>

    <div class="footer">
      <div class="copyright">
        Copyright © 2009-2010, Douglas Creager.  All rights reserved.
      </div>
    </div>

  </body>
</html>

