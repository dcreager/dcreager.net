<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
 
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>Using callbacks with the subprocess module</title>
    <meta name="author" content="Douglas Creager" />

    <meta name="google-site-verification" content="7KIoYPNsfdDxIdX1QQ7SM2Nm_nyy13aRlDkzE3wzhhY" />

    

    <link rel="alternate" type="application/atom+xml"
          title="dcreager.net" href="/atom.xml"/>
 
    <!-- syntax highlighting CSS -->
    <link rel="stylesheet" href="/css/syntax.css" type="text/css" />

    <!-- main CSS -->
    <link rel="stylesheet" href="/css/main.css" type="text/css" />

    <!-- Cufon -->
    <script src="/js/jquery-1.4.1.min.js" type="text/javascript"></script>
    <script src="/js/cufon-yui.js" type="text/javascript"></script>
    <script src="/js/Delicious.js" type="text/javascript"></script>
    <script src="/js/Junction.js" type="text/javascript"></script>
    <script src="/js/Tagesschrift.js" type="text/javascript"></script>

    <script type="text/javascript">
      Cufon.replace('.body h1', { fontFamily: 'Delicious' });
      Cufon.replace('.body h2', { fontFamily: 'Delicious' });
      Cufon.replace('.body h3', { fontFamily: 'Delicious' });
      Cufon.replace('.body .postdate', { fontFamily: 'Junction' });
      Cufon.replace('.site_header .title', { fontFamily: 'Tagesschrift' });
      Cufon.replace('.site_header .subtitle', { fontFamily: 'Junction' });
    </script>
  </head>

  <body>

    <!--
       Preload some images.  The “preload” class is set to never
       display.
      -->
    <div class="preload">
      <img src="/images/icon-pdf.png"/>
      <img src="/images/icon-pdf-shadow.png"/>
      <img src="/images/mag.png"/>
      <img src="/images/mag-shadow.png"/>
    </div>

    <div class="site">
      <div class="site_content">
        <div class="left">
          <div class="leftnav">
            <h3><a href="/">Home</a></h3>
<h3><a href="/about/">About</a></h3>
<h3><a href="/archive/">Archive</a></h3>
<h3><a href="/publications/">Publications</a></h3>

          </div>
        </div>

        <div class="site_header">
          <h1 class="title">dcreager.net</p>
          <h2 class="subtitle">a blog about huge data, coding, and miscellanea</p>
        </div>

        <div class="body">
          <h1>Using callbacks with the subprocess module</h1>

<div class="postdate">
  Thursday, August 13, 2009
</div>

<div class="post">
  <p>In a <a href='/2009/08/06/subprocess-communicate-drawbacks/'>previous post</a>, we pointed out two drawbacks of Python&#8217;s <code>subprocess.communicate</code> method. In this post, we look at the first problem in more detail. To reiterate, the problem is that we collect the subprocess&#8217;s output streams into strings. If the subprocess is going to generate a huge amount of output, it can be better to process the output data in a stream-oriented manner — that way we use a constant amount of memory regardless of how much output is produced.</p>

<p>If we look at the <a href='http://svn.python.org/view/python/trunk/Lib/subprocess.py?revision=74029&amp;view=markup'>implementation</a> of the <code>communicate</code> method, we see this:</p>
<div class='highlight'><pre><code class='python'><span class='lineno'> 1</span> <span class='k'>def</span> <span class='nf'>_communicate_with_select</span><span class='p'>(</span><span class='bp'>self</span><span class='p'>,</span> <span class='nb'>input</span><span class='p'>):</span>
<span class='lineno'> 2</span>     <span class='n'>read_set</span> <span class='o'>=</span> <span class='p'>[]</span>
<span class='lineno'> 3</span>     <span class='n'>write_set</span> <span class='o'>=</span> <span class='p'>[]</span>
<span class='lineno'> 4</span>     <span class='n'>stdout</span> <span class='o'>=</span> <span class='bp'>None</span> <span class='c'># Return</span>
<span class='lineno'> 5</span>     <span class='n'>stderr</span> <span class='o'>=</span> <span class='bp'>None</span> <span class='c'># Return</span>
<span class='lineno'> 6</span> 
<span class='lineno'> 7</span>     <span class='k'>if</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>stdin</span> <span class='ow'>and</span> <span class='nb'>input</span><span class='p'>:</span>
<span class='lineno'> 8</span>         <span class='n'>write_set</span><span class='o'>.</span><span class='n'>append</span><span class='p'>(</span><span class='bp'>self</span><span class='o'>.</span><span class='n'>stdin</span><span class='p'>)</span>
<span class='lineno'> 9</span>     <span class='k'>if</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>stdout</span><span class='p'>:</span>
<span class='lineno'>10</span>         <span class='n'>read_set</span><span class='o'>.</span><span class='n'>append</span><span class='p'>(</span><span class='bp'>self</span><span class='o'>.</span><span class='n'>stdout</span><span class='p'>)</span>
<span class='lineno'>11</span>         <span class='n'>stdout</span> <span class='o'>=</span> <span class='p'>[]</span>
<span class='lineno'>12</span>     <span class='k'>if</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>stderr</span><span class='p'>:</span>
<span class='lineno'>13</span>         <span class='n'>read_set</span><span class='o'>.</span><span class='n'>append</span><span class='p'>(</span><span class='bp'>self</span><span class='o'>.</span><span class='n'>stderr</span><span class='p'>)</span>
<span class='lineno'>14</span>         <span class='n'>stderr</span> <span class='o'>=</span> <span class='p'>[]</span>
<span class='lineno'>15</span> 
<span class='lineno'>16</span>     <span class='n'>input_offset</span> <span class='o'>=</span> <span class='mf'>0</span>
<span class='lineno'>17</span>     <span class='k'>while</span> <span class='n'>read_set</span> <span class='ow'>or</span> <span class='n'>write_set</span><span class='p'>:</span>
<span class='lineno'>18</span>         <span class='k'>try</span><span class='p'>:</span>
<span class='lineno'>19</span>             <span class='n'>rlist</span><span class='p'>,</span> <span class='n'>wlist</span><span class='p'>,</span> <span class='n'>xlist</span> <span class='o'>=</span> <span class='n'>select</span><span class='o'>.</span><span class='n'>select</span><span class='p'>(</span><span class='n'>read_set</span><span class='p'>,</span> <span class='n'>write_set</span><span class='p'>,</span> <span class='p'>[])</span>
<span class='lineno'>20</span>         <span class='k'>except</span> <span class='n'>select</span><span class='o'>.</span><span class='n'>error</span><span class='p'>,</span> <span class='n'>e</span><span class='p'>:</span>
<span class='lineno'>21</span>             <span class='k'>if</span> <span class='n'>e</span><span class='o'>.</span><span class='n'>args</span><span class='p'>[</span><span class='mf'>0</span><span class='p'>]</span> <span class='o'>==</span> <span class='n'>errno</span><span class='o'>.</span><span class='n'>EINTR</span><span class='p'>:</span>
<span class='lineno'>22</span>                 <span class='k'>continue</span>
<span class='lineno'>23</span>             <span class='k'>raise</span>
<span class='lineno'>24</span> 
<span class='lineno'>25</span>         <span class='k'>if</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>stdin</span> <span class='ow'>in</span> <span class='n'>wlist</span><span class='p'>:</span>
<span class='lineno'>26</span>             <span class='n'>chunk</span> <span class='o'>=</span> <span class='nb'>input</span><span class='p'>[</span><span class='n'>input_offset</span> <span class='p'>:</span> <span class='n'>input_offset</span> <span class='o'>+</span> <span class='n'>_PIPE_BUF</span><span class='p'>]</span>
<span class='lineno'>27</span>             <span class='n'>bytes_written</span> <span class='o'>=</span> <span class='n'>os</span><span class='o'>.</span><span class='n'>write</span><span class='p'>(</span><span class='bp'>self</span><span class='o'>.</span><span class='n'>stdin</span><span class='o'>.</span><span class='n'>fileno</span><span class='p'>(),</span> <span class='n'>chunk</span><span class='p'>)</span>
<span class='lineno'>28</span>             <span class='n'>input_offset</span> <span class='o'>+=</span> <span class='n'>bytes_written</span>
<span class='lineno'>29</span>             <span class='k'>if</span> <span class='n'>input_offset</span> <span class='o'>&gt;=</span> <span class='nb'>len</span><span class='p'>(</span><span class='nb'>input</span><span class='p'>):</span>
<span class='lineno'>30</span>                 <span class='bp'>self</span><span class='o'>.</span><span class='n'>stdin</span><span class='o'>.</span><span class='n'>close</span><span class='p'>()</span>
<span class='lineno'>31</span>                 <span class='n'>write_set</span><span class='o'>.</span><span class='n'>remove</span><span class='p'>(</span><span class='bp'>self</span><span class='o'>.</span><span class='n'>stdin</span><span class='p'>)</span>
<span class='lineno'>32</span> 
<span class='lineno'>33</span>         <span class='k'>if</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>stdout</span> <span class='ow'>in</span> <span class='n'>rlist</span><span class='p'>:</span>
<span class='lineno'>34</span>             <span class='n'>data</span> <span class='o'>=</span> <span class='n'>os</span><span class='o'>.</span><span class='n'>read</span><span class='p'>(</span><span class='bp'>self</span><span class='o'>.</span><span class='n'>stdout</span><span class='o'>.</span><span class='n'>fileno</span><span class='p'>(),</span> <span class='mf'>1024</span><span class='p'>)</span>
<span class='lineno'>35</span>             <span class='k'>if</span> <span class='n'>data</span> <span class='o'>==</span> <span class='s'>&quot;&quot;</span><span class='p'>:</span>
<span class='lineno'>36</span>                 <span class='bp'>self</span><span class='o'>.</span><span class='n'>stdout</span><span class='o'>.</span><span class='n'>close</span><span class='p'>()</span>
<span class='lineno'>37</span>                 <span class='n'>read_set</span><span class='o'>.</span><span class='n'>remove</span><span class='p'>(</span><span class='bp'>self</span><span class='o'>.</span><span class='n'>stdout</span><span class='p'>)</span>
<span class='lineno'>38</span>             <span class='n'>stdout</span><span class='o'>.</span><span class='n'>append</span><span class='p'>(</span><span class='n'>data</span><span class='p'>)</span>
<span class='lineno'>39</span> 
<span class='lineno'>40</span>         <span class='k'>if</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>stderr</span> <span class='ow'>in</span> <span class='n'>rlist</span><span class='p'>:</span>
<span class='lineno'>41</span>             <span class='n'>data</span> <span class='o'>=</span> <span class='n'>os</span><span class='o'>.</span><span class='n'>read</span><span class='p'>(</span><span class='bp'>self</span><span class='o'>.</span><span class='n'>stderr</span><span class='o'>.</span><span class='n'>fileno</span><span class='p'>(),</span> <span class='mf'>1024</span><span class='p'>)</span>
<span class='lineno'>42</span>             <span class='k'>if</span> <span class='n'>data</span> <span class='o'>==</span> <span class='s'>&quot;&quot;</span><span class='p'>:</span>
<span class='lineno'>43</span>                 <span class='bp'>self</span><span class='o'>.</span><span class='n'>stderr</span><span class='o'>.</span><span class='n'>close</span><span class='p'>()</span>
<span class='lineno'>44</span>                 <span class='n'>read_set</span><span class='o'>.</span><span class='n'>remove</span><span class='p'>(</span><span class='bp'>self</span><span class='o'>.</span><span class='n'>stderr</span><span class='p'>)</span>
<span class='lineno'>45</span>             <span class='n'>stderr</span><span class='o'>.</span><span class='n'>append</span><span class='p'>(</span><span class='n'>data</span><span class='p'>)</span>
<span class='lineno'>46</span> 
<span class='lineno'>47</span>     <span class='k'>return</span> <span class='p'>(</span><span class='n'>stdout</span><span class='p'>,</span> <span class='n'>stderr</span><span class='p'>)</span>
</code></pre>
</div>
<p>(There are actually several different <code>communicate</code> implementations in the module: a Windows-specific implementation, an implementation using the POSIX <code>poll</code> function, and one using POSIX <code>select</code>. We&#8217;re going to look at the <code>select</code> implementation; the modifications we make can be rolled into the other methods, too.)</p>

<h2 id='output_callbacks'>Output callbacks</h2>

<p>For collecting stdout, the important part is lines 33-38. If the <code>select</code> call tells us that the stdout stream is ready for reading, we try to read up to 1024 bytes from it. If we get the empty string, this means we&#8217;ve reached EOF, and can close down the stream. (We also no longer have to keep passing it in to further <code>select</code> calls, since we know we&#8217;re done with this stream.) If we get a non-empty string, then we append it into a list. The function that calls <code>_communicate_with_select</code> will eventually <code>join</code> this list of strings together, yielding a single string.</p>

<p>It&#8217;s actually a very simple change to make this process the output using a stream-based callback. For now, we assume that we&#8217;ve been given the callback, in a <code>stdout_callback</code> variable. Then, we can change line 38 to</p>
<div class='highlight'><pre><code class='python'>            <span class='n'>stdout_callback</span><span class='p'>(</span><span class='n'>data</span><span class='p'>)</span>
</code></pre>
</div>
<p>The callback can be any Python callable object; it should accept a single argument, which is the next chunk of data from stdout. We can make a similar change to line 45 to send the stderr data to its own <code>stderr_callback</code>.</p>

<h2 id='lineoriented_callbacks'>Line-oriented callbacks</h2>

<p>One possible issue with the output callbacks in the previous section is that the data is sent into the callback in arbitrary chunks. We might prefer to guarantee that the callback will be called exactly once for each <em>line</em> of output. This would allow us, for intsance, to easily interleave the output lines of a bunch of subprocesses into the output of the parent process, without having to worry about locking.</p>

<p>To use a line-based callback, we have to wrap it, creating a arbitrary-chunk callback that buffers data as necessary. Once it receives a full line of data, it sends it to the wrapped line callback.</p>
<div class='highlight'><pre><code class='python'><span class='lineno'> 1</span> <span class='k'>def</span> <span class='nf'>wrap_line_callback</span><span class='p'>(</span><span class='n'>line_callback</span><span class='p'>):</span>
<span class='lineno'> 2</span>     <span class='k'>class</span> <span class='nc'>Callback</span><span class='p'>(</span><span class='nb'>object</span><span class='p'>):</span>
<span class='lineno'> 3</span>         <span class='k'>def</span> <span class='nf'>__init__</span><span class='p'>(</span><span class='bp'>self</span><span class='p'>,</span> <span class='n'>line_callback</span><span class='p'>):</span>
<span class='lineno'> 4</span>             <span class='bp'>self</span><span class='o'>.</span><span class='n'>line_buffer</span> <span class='o'>=</span> <span class='p'>[]</span>
<span class='lineno'> 5</span>             <span class='bp'>self</span><span class='o'>.</span><span class='n'>line_callback</span> <span class='o'>=</span> <span class='n'>line_callback</span>
<span class='lineno'> 6</span> 
<span class='lineno'> 7</span>         <span class='k'>def</span> <span class='nf'>output_buffer</span><span class='p'>(</span><span class='bp'>self</span><span class='p'>):</span>
<span class='lineno'> 8</span>             <span class='n'>line</span> <span class='o'>=</span> <span class='s'>&quot;&quot;</span><span class='o'>.</span><span class='n'>join</span><span class='p'>(</span><span class='bp'>self</span><span class='o'>.</span><span class='n'>line_buffer</span><span class='p'>)</span>
<span class='lineno'> 9</span>             <span class='bp'>self</span><span class='o'>.</span><span class='n'>line_callback</span><span class='p'>(</span><span class='n'>line</span><span class='p'>)</span>
<span class='lineno'>10</span>             <span class='bp'>self</span><span class='o'>.</span><span class='n'>line_buffer</span> <span class='o'>=</span> <span class='p'>[]</span>
<span class='lineno'>11</span> 
<span class='lineno'>12</span>         <span class='k'>def</span> <span class='nf'>data_callback</span><span class='p'>(</span><span class='bp'>self</span><span class='p'>,</span> <span class='n'>data</span><span class='p'>):</span>
<span class='lineno'>13</span>             <span class='c'># If we get an empty string, that represents the end of</span>
<span class='lineno'>14</span>             <span class='c'># the input.  If there is anything in the buffer, send</span>
<span class='lineno'>15</span>             <span class='c'># then out first, then send an empty string on the to line</span>
<span class='lineno'>16</span>             <span class='c'># callback.</span>
<span class='lineno'>17</span> 
<span class='lineno'>18</span>             <span class='k'>if</span> <span class='n'>data</span> <span class='o'>==</span> <span class='s'>&quot;&quot;</span><span class='p'>:</span>
<span class='lineno'>19</span>                 <span class='k'>if</span> <span class='nb'>len</span><span class='p'>(</span><span class='bp'>self</span><span class='o'>.</span><span class='n'>line_buffer</span><span class='p'>)</span> <span class='o'>&gt;</span> <span class='mf'>0</span><span class='p'>:</span>
<span class='lineno'>20</span>                     <span class='bp'>self</span><span class='o'>.</span><span class='n'>output_buffer</span><span class='p'>()</span>
<span class='lineno'>21</span> 
<span class='lineno'>22</span>                 <span class='bp'>self</span><span class='o'>.</span><span class='n'>line_callback</span><span class='p'>(</span><span class='s'>&quot;&quot;</span><span class='p'>)</span>
<span class='lineno'>23</span>                 <span class='k'>return</span>
<span class='lineno'>24</span> 
<span class='lineno'>25</span>             <span class='c'># Otherwise, we split the new data into separate lines,</span>
<span class='lineno'>26</span>             <span class='c'># each of which we call an “entry”.  We add each entry to</span>
<span class='lineno'>27</span>             <span class='c'># the buffer.  If the entry ends with a newline, we output</span>
<span class='lineno'>28</span>             <span class='c'># the buffer and then clear it.</span>
<span class='lineno'>29</span> 
<span class='lineno'>30</span>             <span class='n'>lines</span> <span class='o'>=</span> <span class='n'>data</span><span class='o'>.</span><span class='n'>splitlines</span><span class='p'>(</span><span class='bp'>True</span><span class='p'>)</span>
<span class='lineno'>31</span>             <span class='k'>for</span> <span class='n'>line</span> <span class='ow'>in</span> <span class='n'>lines</span><span class='p'>:</span>
<span class='lineno'>32</span>                 <span class='bp'>self</span><span class='o'>.</span><span class='n'>line_buffer</span><span class='o'>.</span><span class='n'>append</span><span class='p'>(</span><span class='n'>line</span><span class='p'>)</span>
<span class='lineno'>33</span>                 <span class='k'>if</span> <span class='n'>line</span><span class='o'>.</span><span class='n'>endswith</span><span class='p'>((</span><span class='s'>&quot;</span><span class='se'>\r\n</span><span class='s'>&quot;</span><span class='p'>,</span> <span class='s'>&quot;</span><span class='se'>\n</span><span class='s'>&quot;</span><span class='p'>,</span> <span class='s'>&quot;</span><span class='se'>\r</span><span class='s'>&quot;</span><span class='p'>)):</span>
<span class='lineno'>34</span>                     <span class='bp'>self</span><span class='o'>.</span><span class='n'>output_buffer</span><span class='p'>()</span>
<span class='lineno'>35</span> 
<span class='lineno'>36</span>             <span class='k'>return</span>
<span class='lineno'>37</span> 
<span class='lineno'>38</span>     <span class='k'>return</span> <span class='n'>Callback</span><span class='p'>(</span><span class='n'>line_callback</span><span class='p'>)</span><span class='o'>.</span><span class='n'>data_callback</span>
</code></pre>
</div>
<ul>
<li>
<p><strong>line 1</strong> — We start by declaring the wrapping function. It will take in a line-based callback, and return an arbitrary-chunk callback.</p>
</li>

<li>
<p><strong>lines 2-5</strong> — We&#8217;ll need to maintain some state in between invocations of the arbitrary-chunk callback — specifically, if a line of output data falls across a chunk boundary, we&#8217;ll need to hold onto the part in the first chunk until we receive the part in the second chunk. One relatively easy way to do this is to create a new class, and store the state in <code>self</code> properties. Note that the <code>Callback</code> class is declared inside the <code>wrap_line_callback</code> function.</p>

<p>The buffer is a list of strings. This needs to be a list to support arbitrarily long lines, since we don&#8217;t know how many chunks we&#8217;ll need to store before outputting the line.</p>
</li>

<li>
<p><strong>lines 7-10</strong> — We also declare a method in the class that can output the current contents of the saved buffer (if any). Like the original <code>communicate</code> method, we join the buffer list together into a single string, then pass it onto the wrapped line callback.</p>
</li>

<li>
<p><strong>lines 12-23</strong> — Next we can define the arbitrary-chunk callback. First, it checks to see if we&#8217;ve received an EOF indicator (the empty string). If so, we first output whatever is currently in the buffer; then we pass on the EOF to the line callback.</p>
</li>

<li>
<p><strong>lines 25-34</strong> — If we get some actual data, we first split the current chunk into separate lines. We pass in a <code>True</code> parameter to the <code>splitlines</code> method so that we get the newlines in the split strings. This will let us tell if the final string in the list represents a complete line, or if it&#8217;s the first part of a line that falls across a chunk boundary.</p>

<p>We then loop through the split strings, adding them to the buffer. If any of them end with one of the newline endings (Unix, Windows, or otherwise), we output the buffer. Note that only the last string in the <code>lines</code> list can end with something other than a newline; anything at the beginning of the list is only a separate element because <code>splitlines</code> found a newline to split on!</p>
</li>

<li>
<p><strong>line 38</strong> — Finally, we instantiate the new class and return its arbitrary-chunk callback.</p>
</li>
</ul>

<h2 id='more_to_come'>More to come</h2>

<p>This gives us a nice output callback mechanism, to prevent us from buffering the entire contents of the stdout and stderr streams in memory. In later posts, we&#8217;ll look at doing the same with the <em>input</em> data, and then we&#8217;ll address the second problem, of dealing with more than one subprocess simultaneously.</p>
</div>


<div class="posttags">
  Tags:
  <ul>
    
    <li><a href="/tags/python/">python</a></li>
    
    <li><a href="/tags/subprocess/">subprocess</a></li>
    
  </ul>
</div>


        </div>

        

        <div class="body_separator"></div>

        <div class="body">
          <div id="disqus_thread"></div>

          <script type="text/javascript">
            var disqus_title = "Using callbacks with the subprocess module";
            var disqus_url = "http://dcreager.net/2009/08/13/subprocess-callbacks/";
          </script>

          <script
             type="text/javascript"
             src="http://disqus.com/forums/dcreager/embed.js">
          </script>
          <noscript>
            <a href="http://dcreager.disqus.com/?url=ref">View the discussion thread.</a>
          </noscript>

          <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
        </div>

        

      </div>
    </div>

    <div class="footer">
      <div class="copyright">
        Copyright © 2009-2010, Douglas Creager.  All rights reserved.
      </div>
    </div>

    <script type="text/javascript"> Cufon.now(); </script>
  </body>
</html>

