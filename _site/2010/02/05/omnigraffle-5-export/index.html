<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
 
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>Updating graffle-export to work with OmniGraffle 5</title>
    <meta name="author" content="Douglas Creager" />

    <meta name="google-site-verification" content="7KIoYPNsfdDxIdX1QQ7SM2Nm_nyy13aRlDkzE3wzhhY" />

    

    <link rel="alternate" type="application/atom+xml"
          title="dcreager.net" href="/atom.xml"/>
 
    <!-- syntax highlighting CSS -->
    <link rel="stylesheet" href="/css/syntax.css" type="text/css" />

    <!-- main CSS -->
    <link rel="stylesheet" href="/css/main.css" type="text/css" />

    <!-- Cufon -->
    <script src="/js/jquery-1.4.1.min.js" type="text/javascript"></script>
    <script src="/js/cufon-yui.js" type="text/javascript"></script>
    <script src="/js/Delicious.js" type="text/javascript"></script>
    <script src="/js/Junction.js" type="text/javascript"></script>
    <script src="/js/Tagesschrift.js" type="text/javascript"></script>

    <script type="text/javascript">
      Cufon.replace('.body h1', { fontFamily: 'Delicious' });
      Cufon.replace('.body h2', { fontFamily: 'Delicious' });
      Cufon.replace('.body h3', { fontFamily: 'Delicious' });
      Cufon.replace('.body .postdate', { fontFamily: 'Junction' });
      Cufon.replace('.site_header .title', { fontFamily: 'Tagesschrift' });
      Cufon.replace('.site_header .subtitle', { fontFamily: 'Junction' });
    </script>
  </head>

  <body>

    <!--
       Preload some images.  The “preload” class is set to never
       display.
      -->
    <div class="preload">
      <img src="/images/icon-pdf.png"/>
      <img src="/images/icon-pdf-shadow.png"/>
      <img src="/images/mag.png"/>
      <img src="/images/mag-shadow.png"/>
    </div>

    <div class="site">
      <div class="site_content">
        <div class="left">
          <div class="leftnav">
            <h3><a href="/">Home</a></h3>
<h3><a href="/about/">About</a></h3>
<h3><a href="/archive/">Archive</a></h3>
<h3><a href="/publications/">Publications</a></h3>

          </div>
        </div>

        <div class="site_header">
          <h1 class="title">dcreager.net</p>
          <h2 class="subtitle">a blog about huge data, coding, and miscellanea</p>
        </div>

        <div class="body">
          <h1>Updating graffle-export to work with OmniGraffle 5</h1>

<div class="postdate">
  Friday, February 05, 2010
</div>

<div class="post">
  <p>I recently upgraded to OmniGraffle 5, which caused my <a href='http://github.com/dcreager/graffle-export/'>graffle-export</a> script to break:</p>

<pre><code>$ graffle.sh ~/git/cwa/figures/analyst.graffle foo.pdf 
OmniGraffle Professional 5
/Users/dcreager/git/cwa/figures/analyst.graffle
./graffle.scpt: execution error: OmniGraffle Professional 5 got an error: The document cannot be exported to the &quot;pdf&quot; format. (-50)</code></pre>

<p>(This was first reported to me by Nima Talebi as <a href='http://github.com/dcreager/graffle-export/issues/issue/1'>a ticket</a> on graffle-export&#8217;s Github page.)</p>

<p>Before we can understand what error we&#8217;re seeing, a little explanation is in order. The core logic of the OmniGraffle exporter is an AppleScript. Unfortunately, AppleScripts are stored in a binary format, so if you go to the Github page, you can&#8217;t easily view the contents of the file. The important line of the script is:</p>
<div class='highlight'><pre><code class='applescript'><span class='nv'>save</span> <span class='nv'>doc</span> <span class='k'>as</span> <span class='nv'>format</span> <span class='k'>in</span> <span class='nv'>file</span> <span class='nv'>output</span>
</code></pre>
</div>
<p>This saves an OmniGraffle document (which an earlier part of the script makes sure is open) into a new output file. The <code>output</code> variable is the name of the desired output file, and is taken directly from the <em>graffle.sh</em> command line.</p>

<p>The <code>format</code> variable is what&#8217;s causing us problems. This parameter to the <code>save</code> command tells OmniGraffle what format to use for the file it&#8217;s about to save. This is how we get our export functionality; we just give it the name of one of the export formats that it supports. The value of our <code>format</code> variable comes from the optional first parameter to the <em>graffle.sh</em> script. Previously, if no value was specified, I used &#8221;<code>pdf</code>&#8221; as a default.</p>

<p>Now, there&#8217;s no real documentation that I&#8217;ve been able to find out what values are allowed for this parameter. I came across <code>pdf</code> simply by trial and error. &#8221;<code>PDF</code>&#8221; also seems to work, as does &#8221;<code>PDF
vector image</code>&#8221;, which is the text that appears in the Format entry of OmniGraffle&#8217;s Export dialog box.</p>

<p>Or, to be more accurate, I should say that these values all work <strong>in OmniGraffle 4</strong>. Once you upgrade to version 5, these values no longer seem to be valid choices for that parameter of the <code>save</code> command — hence the error message. A quick, non-exhaustive test shows that none of these variations work for EPS or SVG, either. The only one that seems to still work is PNG.</p>

<p>So, what are we to do? After looking at several other related AppleScripts on the web, it seems that the <code>as</code> parameter of the <code>save</code> command is optional. After some experimentation, it turns out that if you leave out this parameter, OmniGraffle tries to deduce the correct output format based on the extension of your output filename. So, we change our <code>save</code> command to the following:</p>
<div class='highlight'><pre><code class='applescript'><span class='k'>if</span> <span class='nv'>format</span> <span class='o'>=</span> <span class='s2'>&quot;&quot;</span> <span class='k'>then</span>
  <span class='nv'>save</span> <span class='nv'>doc</span> <span class='k'>in</span> <span class='nv'>file</span> <span class='nv'>output</span>
<span class='k'>else</span>
  <span class='nv'>save</span> <span class='nv'>doc</span> <span class='k'>as</span> <span class='nv'>format</span> <span class='k'>in</span> <span class='nv'>file</span> <span class='nv'>output</span>
<span class='k'>end</span> <span class='k'>if</span>
</code></pre>
</div>
<p>(We also have to modify the <em>graffle.sh</em> wrapper script to not use <code>pdf</code> as a default, but you can see that change <a href='http://github.com/dcreager/graffle-export/commit/b605b461a29b73ab4c21bd42b48549bd8bad8fcc'>on Github</a>.) This lets us export a PDF version of a <em>.graffle</em> file by giving an output filename ending in <em>.pdf</em>, and leaving out the format parameter.</p>

<p>I still have my old copy of OmniGraffle 4, and it looks like this trick works with that version as well. So, this is now the default behavior, regardless of which version you have installed.</p>

<p>It would be nice if there was an accurate list of what values were allowed for the <code>as</code> parameter, but we do have a working solution, at least. The only problem is if you want to export a PDF with a different extension; with this solution, you&#8217;d have to export to a <em>.pdf</em> file and then rename it to your new extension. But then again, why would you want to do that?</p>
</div>


<div class="posttags">
  Tags:
  <ul>
    
    <li><a href="/tags/omnigraffle/">omnigraffle</a></li>
    
    <li><a href="/tags/papers/">papers</a></li>
    
  </ul>
</div>


        </div>

        

        <div class="body_separator"></div>

        <div class="body">
          <div id="disqus_thread"></div>

          <script type="text/javascript">
            var disqus_title = "Updating graffle-export to work with OmniGraffle 5";
            var disqus_url = "http://dcreager.net/2010/02/05/omnigraffle-5-export/";
          </script>

          <script
             type="text/javascript"
             src="http://disqus.com/forums/dcreager/embed.js">
          </script>
          <noscript>
            <a href="http://dcreager.disqus.com/?url=ref">View the discussion thread.</a>
          </noscript>

          <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
        </div>

        

      </div>
    </div>

    <div class="footer">
      <div class="copyright">
        Copyright © 2009-2010, Douglas Creager.  All rights reserved.
      </div>
    </div>

    <script type="text/javascript"> Cufon.now(); </script>
  </body>
</html>

