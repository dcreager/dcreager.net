<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
 
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>Using LLVM's link-time optimization on Ubuntu Karmic</title>
    <meta name="author" content="Douglas Creager" />

    <meta name="google-site-verification" content="7KIoYPNsfdDxIdX1QQ7SM2Nm_nyy13aRlDkzE3wzhhY" />

    

    <link rel="alternate" type="application/atom+xml"
          title="dcreager.net" href="/atom.xml"/>
 
    <!-- syntax highlighting CSS -->
    <link rel="stylesheet" href="/css/syntax.css" type="text/css" />

    <!-- main CSS -->
    <link rel="stylesheet" href="/css/main.css" type="text/css" />

    <!-- Cufon -->
    <script src="/js/jquery-1.4.1.min.js" type="text/javascript"></script>
    <script src="/js/cufon-yui.js" type="text/javascript"></script>
    <script src="/js/Delicious.js" type="text/javascript"></script>
    <script src="/js/Junction.js" type="text/javascript"></script>
    <script src="/js/Tagesschrift.js" type="text/javascript"></script>

    <script type="text/javascript">
      Cufon.replace('.body h1', { fontFamily: 'Delicious' });
      Cufon.replace('.body h2', { fontFamily: 'Delicious' });
      Cufon.replace('.body h3', { fontFamily: 'Delicious' });
      Cufon.replace('.body .postdate', { fontFamily: 'Junction' });
      Cufon.replace('.site_header .title', { fontFamily: 'Tagesschrift' });
      Cufon.replace('.site_header .subtitle', { fontFamily: 'Junction' });
    </script>
  </head>

  <body>

    <!--
       Preload some images.  The “preload” class is set to never
       display.
      -->
    <div class="preload">
      <img src="/images/icon-pdf.png"/>
      <img src="/images/icon-pdf-shadow.png"/>
      <img src="/images/mag.png"/>
      <img src="/images/mag-shadow.png"/>
    </div>

    <div class="site">
      <div class="site_content">
        <div class="left">
          <div class="leftnav">
            <h3><a href="/">Home</a></h3>
<h3><a href="/about/">About</a></h3>
<h3><a href="/archive/">Archive</a></h3>
<h3><a href="/publications/">Publications</a></h3>

          </div>
        </div>

        <div class="site_header">
          <h1 class="title">dcreager.net</p>
          <h2 class="subtitle">a blog about huge data, coding, and miscellanea</p>
        </div>

        <div class="content">

        <div class="body">
          <h1>Using LLVM's link-time optimization on Ubuntu Karmic</h1>

<div class="postdate">
  Wednesday, February 17, 2010
</div>

<div class="post">
  <p>While playing around with <a href='http://github.com/dcreager/libpush'>libpush</a> on my MacBook, I was pleasantly surprised to see a huge performance increase when I used the link-time optimization (LTO) feature of the LLVM GCC front end. (It&#8217;s really quite nifty; the new <a href='http://github.com/mxcl/homebrew'>Homebrew package manager</a> uses it by default when compiling packages.) On MacOS, using LTO is as simple as using <code>llvm-gcc</code> as your C compiler (or <code>llvm-g++</code> if you&#8217;re compiling C++), and passing in <code>-O4</code> as your optimization flag. I use SCons as my builder, so this turns into:</p>

<pre><code>$ scons CC=llvm-gcc CCFLAGS=-O4</code></pre>

<p>This will cause GCC to output LLVM bytecode into the <em>.o</em> output files, and to perform whole-program optimizations during each linking phase. I was able to see a big performance win simply from the linker being able to inline in copies of small functions that live in “other” compilation units.</p>

<h2 id='good_news_and_bad_news'>Good news and bad news</h2>

<p>Intrigued by the results, I wanted to try the same thing on my Linux boxes, which are running Ubuntu Karmic. On the Mac, Apple has made sure to include support for LLVM in all of the standard Xcode build tools. On Linux, you don&#8217;t get this by default right now — though GCC is implementing their own LTO project, which is starting to bear fruit. Part of this is a new “<code>gold</code>” linker, which supports a plugin architecture. How is this useful to us? Well, LLVM already has a <a href='http://llvm.org/docs/GoldPlugin.html'>plugin</a> for the new linker, so with everything installed correctly, getting LTO through LLVM on Linux can be just as simple as it was on the Mac.</p>

<p>Unfortunately, these new tools have only partially made it into the Ubuntu package tree. You can get the new <code>gold</code> linker by installing the <code>binutils-gold</code> package, and you can get most of the LLVM pieces by installing the <code>llvm</code> and <code>llvm-gcc-4.2</code> packages. Unfortunately, this doesn&#8217;t include the LLVM <code>gold</code> plugin or the new <code>clang</code> C/C++ compiler front-end. Things look promising for these features being in the new Lucid packages — which could even lead to a Karmic backport — but for now, if we want the <code>gold</code> plugin, we have to compile ourselves.</p>

<h2 id='getting_the_prerequisites'>Getting the prerequisites</h2>

<p>As mentioned on the LLVM <a href='http://llvm.org/docs/GoldPlugin.html'>linker plugin page</a>, you need to have the <code>binutils</code> source lying around somewhere if you want to compile the plugin, since the LLVM source needs to read in <code>binutils</code>&#8217;s <em>plugin-api.h</em> file. The easiest way for us to get the <code>binutils</code> source is using APT:</p>

<pre><code>$ mkdir -p $HOME/deb
$ cd $HOME/deb
$ apt-get source binutils</code></pre>

<p>This will place an unpacked copy of the <code>binutils</code> source into <em>$HOME/deb/binutils-2.20</em> for you.</p>

<p>We can also go ahead and install the <code>gold</code> linker:</p>

<pre><code>$ sudo apt-get install binutils-gold</code></pre>

<p>You&#8217;ll also need to make sure you&#8217;ve got the basic compilation tools installed (though if you&#8217;re at the point where you&#8217;re trying to play around with LTO, I&#8217;ve got to assume you&#8217;ve already taken care of this&#8230;):</p>

<pre><code>$ sudo apt-get install build-essential</code></pre>

<p>Finally, my main Linux box is 64-bit, so I need to install multilib support before we can compile the LLVM GCC front end:</p>

<pre><code>$ sudo apt-get install gcc-multilib</code></pre>

<h2 id='compiling_llvm'>Compiling LLVM</h2>

<p>With all of the prerequisites installed, we can download and unpack LLVM:</p>

<pre><code>$ mkdir -p $HOME/tmp
$ cd $HOME/tmp
$ wget http://llvm.org/releases/2.6/llvm-2.6.tar.gz
$ wget http://llvm.org/releases/2.6/clang-2.6.tar.gz

$ tar xzvf llvm-2.6.tar.gz
$ tar xzvf clang-2.6.tar.gz</code></pre>

<p><code>clang</code> is distributed as a separate download, but we actually want to place it into the main LLVM directory; the LLVM build scripts will find it and build it automatically:</p>

<pre><code>$ mv clang-2.6 llvm-2.6/tools/clang</code></pre>

<p>At this point we can do the usual compilation steps:</p>

<pre><code>$ cd llvm-2.6
$ ./configure \
    --with-binutils-include=$HOME/deb/binutils-2.20/include \
    --enable-optimized \
    --prefix=/usr/local
$ make
$ sudo make install
$ sudo ldconfig</code></pre>

<p>Notice how we&#8217;re going to install everything into <em>/usr/local</em>, so as not to step on the toes of the package manager. This means we have to run <code>ldconfig</code> so that the system linker knows about the new libraries we just put in <em>/usr/local/lib</em>.</p>

<h2 id='compiling_llvmgcc'>Compiling LLVM-GCC</h2>

<p>At this point, we have the <code>gold</code> linker installed, and have a copy of LLVM that includes its <code>gold</code> plugin. Ideally, we could start compiling with <code>clang</code> and get LTO, but it doesn&#8217;t seem like there&#8217;s currently a way to have <code>clang</code> pass in the necessary <code>--plugin</code> option to the linker. So, all we need now is the GCC front end.</p>

<p>As before, we start by downloading and unpacking:</p>

<pre><code>$ cd $HOME/tmp
$ wget http://llvm.org/releases/2.6/llvm-gcc-4.2-2.6.source.tar.gz
$ tar xzvf llvm-gcc-4.2-2.6.source.tar.gz</code></pre>

<p>The <em>README.LLVM</em> file in the source tree gives more detail on the options you have available; for me, the following worked:</p>

<pre><code>$ mkdir -p $HOME/tmp/obj
$ cd $HOME/tmp/obj
$ ../llvm-gcc-4.2-2.6.source/configure \
    --prefix=/usr/local \
    --program-prefix=llvm- \
    --enable-llvm=$HOME/tmp/llvm-2.6 \
    --enable-languages=c,c++
$ make
$ sudo make install
$ sudo ldconfig</code></pre>

<p>The only interesting wrinkle is that we have to do an out-of-source build — the object files will end up in the <em>$HOME/tmp/obj</em> directory, rather than being created directly in the unpacked source directory.</p>

<p>As this point we&#8217;re nearly there; we have <code>llvm-gcc</code> installed, but its <code>-use-gold-plugin</code> option won&#8217;t work just yet. If you look closely at one sentence on the <a href='http://llvm.org/docs/GoldPlugin.html'>LLVM plugin page</a>, you&#8217;ll see that the option “looks for the <code>gold</code> plugin in the same directories as it looks for <code>cc1</code>”. The LLVM GCC package installed the <code>cc1</code> program into the <em>/usr/local/libexec/gcc/x86_64-unknown-linux-gnu/4.2.1</em> directory. (The <em>x86_64</em> will be different if you&#8217;re on a different architecture.) However, the LLVM plugin is in <em>/usr/local/lib</em>. If you try to use the <code>-use-gold-plugin</code> parameter, you&#8217;ll get the following error message:</p>

<pre><code>$ llvm-gcc -use-gold-plugin \
    -o foo.o -c -O4 -g -Wall -Werror foo.c
llvm-gcc: -use-gold-plugin, but libLLVMgold.so not found.</code></pre>

<p>Not good. The solution (which is admittedly a bit of a hack) is to copy the plugin into the directory that <code>llvm-gcc</code> expects to find it in:</p>

<pre><code>$ sudo cp /usr/local/lib/libLLVMgold.so \
    /usr/local/libexec/gcc/x86_64-unknown-linux-gnu/4.2.1</code></pre>

<h2 id='using_your_new_toy'>Using your new toy</h2>

<p>Now that we&#8217;ve got all of the pieces installed, you can create libraries and executables that are optimized at link time. The “Quickstart” section at the end of the <a href='http://llvm.org/docs/GoldPlugin.html'>LLVM plugin page</a> gives you the outline. I use SCons as my build tool, so I have to run the following:</p>

<pre><code>$ scons \
    CC=&quot;llvm-gcc -use-gold-plugin&quot; \
    AR=&quot;ar --plugin libLLVMgold.so&quot; \
    RANLIB=/bin/true \
    CCFLAGS=-O4</code></pre>

<p>This is slightly more than what&#8217;s needed on the Mac, but all in all, not bad. Enjoy!</p>
</div>


<div class="posttags">
  Tags:
  <ul>
    
    <li><a href="/tags/ubuntu/">ubuntu</a></li>
    
    <li><a href="/tags/llvm/">llvm</a></li>
    
  </ul>
</div>


        </div>

        <script type="text/javascript"> Cufon.now(); </script>

        

        <div class="body_separator"></div>

        <div class="body">
          <div id="disqus_thread"></div>

          <script type="text/javascript">
            var disqus_title = "Using LLVM's link-time optimization on Ubuntu Karmic";
            var disqus_url = "http://dcreager.net/2010/02/17/llvm-lto-karmic/";
          </script>

          <script
             type="text/javascript"
             src="http://disqus.com/forums/dcreager/embed.js">
          </script>
          <noscript>
            <a href="http://dcreager.disqus.com/?url=ref">View the discussion thread.</a>
          </noscript>

          <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
        </div>

        

        </div>

      </div>
    </div>

    <div class="footer">
      <div class="copyright">
        Copyright © 2009-2010, Douglas Creager.  All rights reserved.
      </div>
    </div>
  </body>
</html>

