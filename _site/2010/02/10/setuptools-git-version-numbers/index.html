<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
 
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>Extracting setuptools version numbers from your git repository</title>
    <meta name="author" content="Douglas Creager" />

    <meta name="google-site-verification" content="7KIoYPNsfdDxIdX1QQ7SM2Nm_nyy13aRlDkzE3wzhhY" />

    

    <link rel="alternate" type="application/atom+xml"
          title="dcreager.net" href="/atom.xml"/>
 
    <!-- syntax highlighting CSS -->
    <link rel="stylesheet" href="/css/syntax.css" type="text/css" />

    <!-- main CSS -->
    <link rel="stylesheet" href="/css/main.css" type="text/css" />
  </head>

  <body>

    <!--
       Preload some images.  The “preload” class is set to never
       display.
      -->
    <div class="preload">
      <img src="/images/icon-pdf.png"/>
      <img src="/images/icon-pdf-shadow.png"/>
      <img src="/images/mag.png"/>
      <img src="/images/mag-shadow.png"/>
    </div>

    <div class="site">
      <div class="site_content">
        <div class="left">
          <div class="leftnav">
            <p><a href="/">Home</a></p>
<p><a href="/about/">About</a></p>
<p><a href="/archive/">Archive</a></p>
<p><a href="/publications/">Publications</a></p>

          </div>
        </div>

        <div class="site_header">
          <p class="title">dcreager.net</p>
          <p class="subtitle">A BLOG ABOUT HUGE DATA, CODING, AND MISCELLANEA</p>
        </div>

        <div class="body">
          <h1>Extracting setuptools version numbers from your git repository</h1>

<div class="postdate">
  Wednesday, February 10, 2010
</div>

<div class="post">
  <p>Just like everyone else, we&#8217;re using <a href='http://pypi.python.org/pypi/setuptools'>setuptools</a> as the core of the build system for our Python-based projects. For the most part, this has been a painless, straightforward process. However, one lingering annoyance is that we&#8217;ve been specifying the version number directly in our <em>setup.py</em> files:</p>
<div class='highlight'><pre><code class='python'><span class='kn'>from</span> <span class='nn'>setuptools</span> <span class='kn'>import</span> <span class='n'>setup</span>

<span class='n'>setup</span><span class='p'>(</span>
    <span class='n'>name</span> <span class='o'>=</span> <span class='s'>&quot;awesomelib&quot;</span><span class='p'>,</span>
    <span class='n'>version</span> <span class='o'>=</span> <span class='s'>&quot;1.2&quot;</span><span class='p'>,</span>
    <span class='c'># ...etc</span>
<span class='p'>)</span>
</code></pre>
</div>
<p>On our maintenance branches, we get a nice <em>awesomelib-1.2.tar.gz</em> file when we run <code>python setup.py sdist</code>. On our development branch, we&#8217;ve also got the following <em>setup.cfg</em> file:</p>
<div class='highlight'><pre><code class='ini'><span class='k'>[egg_info]</span>
<span class='na'>tag_build</span> <span class='o'>=</span> <span class='s'>dev</span>
<span class='na'>tag_date</span> <span class='o'>=</span> <span class='s'>true</span>
</code></pre>
</div>
<p>That gives us tarballs like <em>awesomelib-1.2dev-20100210.tar.gz</em> on our development branch. Because we&#8217;re using the <code>dev</code> suffix, which setuptools considers to be a &#8220;prerelease&#8221;, we have to remember to increment the version number in development whenever we cut a new release. The end result is that we have a longish process for creating releases. If we want to create a new 1.3 release, we have to do the following:</p>

<ol>
<li>
<p>Create a new maintenance branch for 1.3:</p>

<pre><code>$ git checkout -b maint-1.3 master</code></pre>
</li>

<li>
<p>Update the <em>setup.cfg</em> file to remove the <code>tag_build</code> and <code>tag_date</code> entries. Commit this with a &#8220;Tagging version 1.3&#8221; commit message.</p>
</li>

<li>
<p>Back on the development branch, update <em>setup.py</em> to increment the &#8220;development version&#8221; to 1.4.</p>
</li>
</ol>

<p>Granted, this isn&#8217;t horribly difficult, but we can do better.</p>

<h2 id='calculating_the_version_automatically'>Calculating the version automatically</h2>

<p>Taking a page from the <a href='http://git.kernel.org/?p=git/git.git;a=blob;f=GIT-VERSION-GEN'><em>GIT-VERSION-GEN</em></a> script in git&#8217;s source code, we&#8217;re going to use the <code>git describe</code> command to automatically generate the version number.</p>

<p>Our logic is implemented in a new <code>get_git_version()</code> Python function, which you can call directly from your <em>setup.py</em> scripts. You can find the source code in a <a href='http://gist.github.com/300803'>Github gist</a>. Our basic strategy is:</p>

<ol>
<li>
<p>First, try to use <code>git describe</code> to create a version number.</p>
</li>

<li>
<p>If this fails, then we&#8217;re most likely not in a git working copy. Probably, someone downloaded a release tarball and unpacked it, and we&#8217;re running inside of there. In this case, <code>git describe</code> can&#8217;t give us a version number. Instead, we&#8217;re going to make sure we include a <em>RELEASE-VERSION</em> file in every tarball that we create. So, if <code>git describe</code> fails, we fall back on the contents of this file as our version number.</p>
</li>
</ol>

<h3 id='tag_names_as_version_numbers'>Tag names as version numbers</h3>

<p>One thing to notice about this strategy is that we use the output of <code>git describe</code> directly as our version number. This means that our tag names should be simple version numbers, without decoration. To create the awesomelib 1.3 release from our example, we&#8217;d just do:</p>

<pre><code>$ git tag -s 1.3</code></pre>

<p>(Note that the tag needs to be an annotated or signed tag in order to be picked up by <code>git describe</code>.)</p>

<p>On our development branch, once we&#8217;ve created new commits on top of the release point, we&#8217;ll start getting output like this from <code>git
describe</code>:</p>

<pre><code>1.3-4-g6f32</code></pre>

<p>This is a valid setuptools &#8220;postrelease&#8221; — setuptools will consider this to be a more recent version than <code>1.3</code>, which is exactly what we want. This eliminates the need to maintain different <em>setup.cfg</em> files in our development and maintenance branches.</p>

<h3 id='getting_the_version_number_of_a_distribution_tarball'>Getting the version number of a distribution tarball</h3>

<p>Another thing to notice is that we need to maintain a <em>RELEASE-VERSION</em> file, ensuring that it always contains the current version, and always including it when we create any source packages. That way, we can still get the current version number, even if we can&#8217;t get it from <code>git describe</code>.</p>

<p>To keep the <em>RELEASE-VERSION</em> file up-to-date, the <code>get_git_version()</code> function always read in the current contents of the file as its first step. If the output of <code>git describe</code> differs from what&#8217;s in the file, we update the file with the new output before returning the version.</p>

<p>This ensures that the file has the right contents, but we also have to make sure we include it in our source packages. To do this, we simply add the following line to our <em>MANIFEST.in</em> file (creating it if necessary):</p>

<pre><code>include RELEASE-VERSION</code></pre>

<p>(Note that we don&#8217;t want the <em>RELEASE-VERSION</em> file to be checked into the git repository, so we also add it to the top-level <em>.gitignore</em> file.)</p>

<h2 id='the_simpler_release_process'>The simpler release process</h2>

<p>With this script, our release process is now much simpler:</p>

<ol>
<li>
<p>Create a maintenance branch if you want to.</p>
</li>

<li>
<p>Create a signed or annotated tag, whose name is the new version number.</p>
</li>
</ol>

<p>Most importantly, no extra commits are needed, since we don&#8217;t have to edit any version numbers or maintain different <em>setup.cfg</em> files.</p>
</div>


<div class="posttags">
  Tags:
  <ul>
    
    <li><a href="/tags/setuptools/">setuptools</a></li>
    
    <li><a href="/tags/python/">python</a></li>
    
    <li><a href="/tags/git/">git</a></li>
    
  </ul>
</div>


        </div>

        

        <div class="body_separator"></div>

        <div class="body">
          <div id="disqus_thread"></div>

          <script type="text/javascript">
            var disqus_title = "Extracting setuptools version numbers from your git repository";
            var disqus_url = "http://dcreager.net/2010/02/10/setuptools-git-version-numbers/";
          </script>

          <script
             type="text/javascript"
             src="http://disqus.com/forums/dcreager/embed.js">
          </script>
          <noscript>
            <a href="http://dcreager.disqus.com/?url=ref">View the discussion thread.</a>
          </noscript>

          <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
        </div>

        

      </div>
    </div>

    <div class="footer">
      <div class="copyright">
        Copyright © 2009-2010, Douglas Creager.  All rights reserved.
      </div>
    </div>

  </body>
</html>

