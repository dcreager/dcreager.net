<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
 
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>Parser callbacks in libpush, Part 1 — Streams</title>
    <meta name="author" content="Douglas Creager" />

    <meta name="google-site-verification" content="7KIoYPNsfdDxIdX1QQ7SM2Nm_nyy13aRlDkzE3wzhhY" />

    

    <link rel="alternate" type="application/atom+xml"
          title="dcreager.net" href="/atom.xml"/>
 
    <!-- syntax highlighting CSS -->
    <link rel="stylesheet" href="/css/syntax.css" type="text/css" />

    <!-- main CSS -->
    <link rel="stylesheet" href="/css/main.css" type="text/css" />

    <!-- Cufon -->
    <script src="/js/jquery-1.4.1.min.js" type="text/javascript"></script>
    <script src="/js/cufon-yui.js" type="text/javascript"></script>
    <script src="/js/Delicious.js" type="text/javascript"></script>
    <script src="/js/Junction.js" type="text/javascript"></script>
    <script src="/js/Tagesschrift.js" type="text/javascript"></script>

    <script type="text/javascript">
      Cufon.replace('.body h1', { fontFamily: 'Delicious' });
      Cufon.replace('.body h2', { fontFamily: 'Delicious' });
      Cufon.replace('.body h3', { fontFamily: 'Delicious' });
      Cufon.replace('.body .postdate', { fontFamily: 'Junction' });
      Cufon.replace('.site_header .title', { fontFamily: 'Tagesschrift' });
      Cufon.replace('.site_header .subtitle', { fontFamily: 'Junction' });
    </script>
  </head>

  <body>

    <!--
       Preload some images.  The “preload” class is set to never
       display.
      -->
    <div class="preload">
      <img src="/images/icon-pdf.png"/>
      <img src="/images/icon-pdf-shadow.png"/>
      <img src="/images/mag.png"/>
      <img src="/images/mag-shadow.png"/>
    </div>

    <div class="site">
      <div class="site_content">
        <div class="left">
          <div class="leftnav">
            <h3><a href="/">Home</a></h3>
<h3><a href="/about/">About</a></h3>
<h3><a href="/archive/">Archive</a></h3>
<h3><a href="/publications/">Publications</a></h3>

          </div>
        </div>

        <div class="site_header">
          <h1 class="title">dcreager.net</p>
          <h2 class="subtitle">a blog about huge data, coding, and miscellanea</p>
        </div>

        <div class="content">

        <div class="body">
          <h1>Parser callbacks in libpush, Part 1 — Streams</h1>

<div class="postdate">
  Thursday, February 25, 2010
</div>

<div class="post">
  <p>This post is the first in a series that describes the <code>push_callback_t</code> type in the <a href='http://github.com/dcreager/libpush/'>libpush</a> library. In these posts, we&#8217;ll walk through a couple of possible ways to implement callbacks under the covers. At each stage, we&#8217;ll encounter problems with the current design. Fixing these problems should lead closer us to the actual implementation in libpush, and along the way, we&#8217;ll gain a good understanding of how our design decisions affect the performance and usability of the library.</p>

<p>The <code>push_callback_t</code> type is used to define <em>parser callbacks</em>, which are the basic unit of parsing in libpush. Callbacks are pretty simple: they take in an <em>input value</em>, read some data from the <em>input stream</em>, and produce an <em>output value</em>. (The fact that callbacks take in an input value, in addition to reading from the input stream, is what makes them <a href='http://www.haskell.org/arrows/'><em>arrows</em></a> instead of <a href='http://en.wikipedia.org/wiki/Monad_%28functional_programming%29'><em>monads</em></a> — but that&#8217;s a story for a later post).</p>

<h2 id='first_attempt_callbacks_as_functions'>First attempt: Callbacks as functions</h2>

<p>Now, with this simple structure, we might try to implement callbacks as regular C functions. For instance, we could use something like the following to read in a single 32-bit integer:</p>
<div class='highlight'><pre><code class='c'><span class='cp'>#include &lt;stdbool.h&gt;</span>
<span class='cp'>#include &lt;stdint.h&gt;</span>
<span class='cp'>#include &lt;stdio.h&gt;</span>

<span class='n'>bool</span>
<span class='nf'>parse_uint32</span><span class='p'>(</span><span class='kt'>void</span> <span class='o'>*</span><span class='n'>input</span><span class='p'>,</span> <span class='kt'>uint32_t</span> <span class='o'>*</span><span class='n'>output</span><span class='p'>,</span> <span class='kt'>FILE</span> <span class='o'>*</span><span class='n'>stream</span><span class='p'>)</span>
<span class='p'>{</span>
    <span class='kt'>size_t</span>  <span class='n'>num_read</span><span class='p'>;</span>

    <span class='n'>num_read</span> <span class='o'>=</span> <span class='n'>fread</span><span class='p'>(</span><span class='n'>output</span><span class='p'>,</span> <span class='k'>sizeof</span><span class='p'>(</span><span class='kt'>uint32_t</span><span class='p'>),</span> <span class='mi'>1</span><span class='p'>,</span> <span class='n'>stream</span><span class='p'>);</span>
    <span class='k'>return</span> <span class='p'>(</span><span class='n'>num_read</span> <span class='o'>==</span> <span class='mi'>1</span><span class='p'>);</span>
<span class='p'>}</span>
</code></pre>
</div>
<p>This callback ignores its input value, reads in four bytes from the input stream, and uses that to output a <code>uint32_t</code> value. The return value of the function is a boolean, indicating whether the parse was successful or not. This lets us handle <em>parse errors</em> — for instance, if there are only three bytes left in the stream, we can&#8217;t read in a full integer. We return <code>false</code> to indicate this error condition.</p>

<p>We&#8217;ve ignored some details here that aren&#8217;t important for this example — for instance, we don&#8217;t worry about the endianness of the integer, nor do we worry about how the space for the output result is allocated. We just assume that someone will pass in a pointer to a <code>uint32_t</code> variable, and our callback function will store its output value there.</p>

<h2 id='drawbacks'>Drawbacks</h2>

<p>This approach works fine for simple cases, but unfortunately has two drawbacks. First, we&#8217;re limited to parsing from <code>FILE</code> streams. Any real input source will probably be available as a stream, so this might not seem like a huge problem — though it does rule out parsing from a memory buffer, unless you use a non-portable function like <code>fmemopen</code>.</p>

<p>The second, more important, problem is that the parser callback has full control over when and how much to read from the stream. In this example, we try to read in the full four bytes for the <code>uint32_t</code> output value. However, there might not be four bytes available in the stream. If this is because we&#8217;re at the end of a file, then we should treat this as a parse error. If we&#8217;re reading from a network socket, though, another chunk of data might arrive if we wait for a bit.</p>

<p>We could add logic to the callback to read from the stream repeatedly until we got enough data, but then we&#8217;ll start <em>blocking</em> — so that we can distinguish between &#8220;there&#8217;s no more data here <em>yet</em>&#8221; from &#8220;there&#8217;s no more data coming <em>at all</em>&#8221;.</p>

<p>All of this is bad news. First of all, this extra I/O logic is starting to get rather big, and we don&#8217;t want each and every callback to have to include it. And second, we don&#8217;t want the rest of our program to be held hostage by the callback — it should be up to our I/O code to decide whether it&#8217;s okay to block waiting for more input, or whether to whip up a nice <code>select</code> loop of some kind to read things more efficiently.</p>

<p>In the next post, we&#8217;ll describe <em>iteratees</em>, which give us this capability.</p>
</div>


<div class="posttags">
  Tags:
  <ul>
    
    <li><a href="/tags/libpush/">libpush</a></li>
    
    <li><a href="/tags/c/">c</a></li>
    
  </ul>
</div>


        </div>

        <script type="text/javascript"> Cufon.now(); </script>

        

        <div class="body_separator"></div>

        <div class="body">
          <div id="disqus_thread"></div>

          <script type="text/javascript">
            var disqus_title = "Parser callbacks in libpush, Part 1 — Streams";
            var disqus_url = "http://dcreager.net/2010/02/25/libpush-callbacks-part-1/";
          </script>

          <script
             type="text/javascript"
             src="http://disqus.com/forums/dcreager/embed.js">
          </script>
          <noscript>
            <a href="http://dcreager.disqus.com/?url=ref">View the discussion thread.</a>
          </noscript>

          <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
        </div>

        

        </div>

      </div>
    </div>

    <div class="footer">
      <div class="copyright">
        Copyright © 2009-2010, Douglas Creager.  All rights reserved.
      </div>
    </div>
  </body>
</html>

