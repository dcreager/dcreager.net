<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
 
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>Default “scons -c” targets</title>
    <meta name="author" content="Douglas Creager" />

    <meta name="google-site-verification" content="7KIoYPNsfdDxIdX1QQ7SM2Nm_nyy13aRlDkzE3wzhhY" />

    

    <link rel="alternate" type="application/atom+xml"
          title="dcreager.net" href="/atom.xml"/>
 
    <!-- syntax highlighting CSS -->
    <link rel="stylesheet" href="/css/syntax.css" type="text/css" />

    <!-- main CSS -->
    <link rel="stylesheet" href="/css/main.css" type="text/css" />

    <!-- Cufon -->
    <script src="/js/jquery-1.4.1.min.js" type="text/javascript"></script>
    <script src="/js/cufon-yui.js" type="text/javascript"></script>
    <script src="/js/Delicious.js" type="text/javascript"></script>
    <script src="/js/Junction.js" type="text/javascript"></script>
    <script src="/js/Tagesschrift.js" type="text/javascript"></script>

    <script type="text/javascript">
      Cufon.replace('.body h1', { fontFamily: 'Delicious' });
      Cufon.replace('.body h2', { fontFamily: 'Delicious' });
      Cufon.replace('.body h3', { fontFamily: 'Delicious' });
      Cufon.replace('.body .postdate', { fontFamily: 'Junction' });
      Cufon.replace('.site_header .title', { fontFamily: 'Tagesschrift' });
      Cufon.replace('.site_header .subtitle', { fontFamily: 'Junction' });
    </script>
  </head>

  <body>

    <!--
       Preload some images.  The “preload” class is set to never
       display.
      -->
    <div class="preload">
      <img src="/images/icon-pdf.png"/>
      <img src="/images/icon-pdf-shadow.png"/>
      <img src="/images/mag.png"/>
      <img src="/images/mag-shadow.png"/>
    </div>

    <div class="site">
      <div class="site_content">
        <div class="left">
          <div class="leftnav">
            <h3><a href="/">Home</a></h3>
<h3><a href="/about/">About</a></h3>
<h3><a href="/archive/">Archive</a></h3>
<h3><a href="/publications/">Publications</a></h3>

          </div>
        </div>

        <div class="site_header">
          <h1 class="title">dcreager.net</p>
          <h2 class="subtitle">a blog about huge data, coding, and miscellanea</p>
        </div>

        <div class="content">

        <div class="body">
          <h1>Default “scons -c” targets</h1>

<div class="postdate">
  Friday, January 08, 2010
</div>

<div class="post">
  <p>As I mentioned in a <a href='/2009/12/18/make-distclean-in-scons/'>previous post</a>, the automatic “clean” target provided by SCons (<code>scons -c</code>) is very useful for cleaning out build files, without requiring much in the way of configuration. Anything that SCons generates when you run <code>scons</code> will be automatically cleaned when you run <code>scons -c</code>.</p>

<p>While useful, I&#8217;d like more control over the behavior of <code>scons -c</code>. Specifically, being a good TDD junkie, I have several test cases that I can run using <code>scons test</code>:</p>
<div class='highlight'><pre><code class='python'><span class='lineno'>1</span> <span class='n'>build_test</span> <span class='o'>=</span> <span class='n'>env</span><span class='o'>.</span><span class='n'>Program</span><span class='p'>(</span> <span class='o'>...</span> <span class='p'>)</span>
<span class='lineno'>2</span> <span class='n'>env</span><span class='o'>.</span><span class='n'>Alias</span><span class='p'>(</span><span class='s'>&quot;build-tests&quot;</span><span class='p'>,</span> <span class='n'>build_test</span><span class='p'>)</span>
<span class='lineno'>3</span> 
<span class='lineno'>4</span> <span class='n'>run_test</span> <span class='o'>=</span> <span class='n'>env</span><span class='o'>.</span><span class='n'>Alias</span><span class='p'>(</span><span class='s'>&quot;test&quot;</span><span class='p'>,</span> <span class='p'>[</span><span class='n'>build_test</span><span class='p'>],</span>
<span class='lineno'>5</span>                      <span class='p'>[</span><span class='s'>&quot;@</span><span class='si'>%s</span><span class='s'>&quot;</span> <span class='o'>%</span> <span class='n'>build_test</span><span class='p'>[</span><span class='mf'>0</span><span class='p'>]</span><span class='o'>.</span><span class='n'>abspath</span><span class='p'>])</span>
<span class='lineno'>6</span> <span class='n'>env</span><span class='o'>.</span><span class='n'>AlwaysBuild</span><span class='p'>(</span><span class='n'>run_test</span><span class='p'>)</span>
</code></pre>
</div>
<p>By setting it up this way, the test programs aren&#8217;t built by default: you have to explicitly run <code>scons build-tests</code> (if you want to build the tests but not run them) or <code>scons test</code> (if you want to build and run them). Moreover, because of SCons&#8217;s dependency tracking, I can just use <code>scons test</code> as my usual build command during my Edit-Test-Debug loop. SCons will automatically rebuild any changed source files before running the tests.</p>

<p>All of this is great. So what&#8217;s the problem? As I mentioned above, <code>scons -c</code> only cleans the build files that are created by <code>scons</code> — and since I&#8217;ve explicitly set things up so that tests aren&#8217;t <em>built</em> by default, they&#8217;ll also not be <em>cleaned</em> by default. This means that to fully clean out my build targets, I have to run two commands:</p>

<pre><code>$ scons -c
$ scons -c build-tests</code></pre>

<p>Not ideal! I&#8217;d prefer if <code>scons -c</code> cleaned everything, just like <code>make clean</code> would in the Automake world.</p>

<h2 id='the_solution'>The solution</h2>

<p>So how to fix this? First we need to understand how SCons decides what to clean when you run <code>scons -c</code>. The answer is “exactly what&#8217;s built by <code>scons</code>”. And how does SCons decide what to build when you run <code>scons</code>? That&#8217;s what the <code>Default</code> command is for.</p>

<p>For instance, I could add</p>
<div class='highlight'><pre><code class='python'><span class='lineno'>1</span> <span class='n'>env</span><span class='o'>.</span><span class='n'>Default</span><span class='p'>(</span><span class='s'>&quot;build-tests&quot;</span><span class='p'>)</span>
</code></pre>
</div>
<p>to my <em>SConstruct</em> file. This would cause all of my tests to be built by default, and by extension, to have them all cleaned by default, as well.</p>

<p>This is close, since <code>scons -c</code> now does what we want, but this means that <code>scons</code> is now building more than we would like. What we need is a way to have a different list of default targets depending on whether we&#8217;re building or cleaning. Luckily, the <code>GetOption</code> function gives us exactly that:</p>
<div class='highlight'><pre><code class='python'><span class='lineno'>1</span> <span class='k'>if</span> <span class='n'>GetOption</span><span class='p'>(</span><span class='s'>&quot;clean&quot;</span><span class='p'>):</span>
<span class='lineno'>2</span>     <span class='n'>env</span><span class='o'>.</span><span class='n'>Default</span><span class='p'>(</span><span class='s'>&quot;build-tests&quot;</span><span class='p'>)</span>
</code></pre>
</div>
<p>With this in our <em>SConstruct</em> file, the tests will be considered a default target when we&#8217;re cleaning, but not when we&#8217;re building. So now we have what we want: <code>scons</code> builds just the code, <code>scons test</code> builds and runs the tests, and <code>scons -c</code> cleans it all.</p>
</div>


<div class="posttags">
  Tags:
  <ul>
    
    <li><a href="/tags/scons/">scons</a></li>
    
  </ul>
</div>


        </div>

        

        <div class="body_separator"></div>

        <div class="body">
          <div id="disqus_thread"></div>

          <script type="text/javascript">
            var disqus_title = "Default “scons -c” targets";
            var disqus_url = "http://dcreager.net/2010/01/08/default-scons-clean-targets/";
          </script>

          <script
             type="text/javascript"
             src="http://disqus.com/forums/dcreager/embed.js">
          </script>
          <noscript>
            <a href="http://dcreager.disqus.com/?url=ref">View the discussion thread.</a>
          </noscript>

          <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
        </div>

        

        </div>

      </div>
    </div>

    <div class="footer">
      <div class="copyright">
        Copyright © 2009-2010, Douglas Creager.  All rights reserved.
      </div>
    </div>

    <script type="text/javascript"> Cufon.now(); </script>
  </body>
</html>

