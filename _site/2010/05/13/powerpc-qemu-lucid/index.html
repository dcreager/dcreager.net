<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
 
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>Installing Ubuntu Lucid on a PowerPC QEMU virtual machine</title>
    <meta name="author" content="Douglas Creager" />

    <meta name="google-site-verification" content="7KIoYPNsfdDxIdX1QQ7SM2Nm_nyy13aRlDkzE3wzhhY" />

    

    <link rel="alternate" type="application/atom+xml"
          title="dcreager.net" href="/atom.xml"/>
 
    <!-- syntax highlighting CSS -->
    <link rel="stylesheet" href="/css/syntax.css" type="text/css" />

    <!-- main CSS -->
    <link rel="stylesheet" href="/css/main.css" type="text/css" />

    <!-- Cufon -->
    <script src="/js/jquery-1.4.1.min.js" type="text/javascript"></script>
    <script src="/js/cufon-yui.js" type="text/javascript"></script>
    <script src="/js/Delicious.js" type="text/javascript"></script>
    <script src="/js/Junction.js" type="text/javascript"></script>
    <script src="/js/Tagesschrift.js" type="text/javascript"></script>

    <script type="text/javascript">
      Cufon.replace('.body h1', { fontFamily: 'Delicious' });
      Cufon.replace('.body h2', { fontFamily: 'Delicious' });
      Cufon.replace('.body h3', { fontFamily: 'Delicious' });
      Cufon.replace('.body .postdate', { fontFamily: 'Junction' });
      Cufon.replace('.site_header .title', { fontFamily: 'Tagesschrift' });
      Cufon.replace('.site_header .subtitle', { fontFamily: 'Junction' });
    </script>
  </head>

  <body>

    <!--
       Preload some images.  The “preload” class is set to never
       display.
      -->
    <div class="preload">
      <img src="/images/icon-pdf.png"/>
      <img src="/images/icon-pdf-shadow.png"/>
      <img src="/images/mag.png"/>
      <img src="/images/mag-shadow.png"/>
    </div>

    <div class="site">
      <div class="site_content">
        <div class="left">
          <div class="leftnav">
            <h3><a href="/">Home</a></h3>
<h3><a href="/about/">About</a></h3>
<h3><a href="/archive/">Archive</a></h3>
<h3><a href="/publications/">Publications</a></h3>

          </div>
        </div>

        <div class="site_header">
          <h1 class="title">dcreager.net</p>
          <h2 class="subtitle">a blog about huge data, coding, and miscellanea</p>
        </div>

        <div class="content">

        <div class="body">
          <h1>Installing Ubuntu Lucid on a PowerPC QEMU virtual machine</h1>

<div class="postdate">
  Thursday, May 13, 2010
</div>

<div class="post">
  <p>Part of the software I help develop at <a href='http://www.redjack.com/'>RedJack</a> needs to be tested on both little-endian and big-endian machines. Little-endian machines are easy, since everyone and their mother is running on a little-endian Intel or AMD x86 chip. It used to be that big-endian was pretty easy to test, too — just break out your trusty Apple Powerbook G4 and you&#8217;re good to go. Since Apple has shifted over to Intel chips, though, the situation has changed.</p>

<p>Luckily, <a href='http://wiki.qemu.org/'>QEMU</a> has PowerPC as one of the targets that it can emulate, so in theory, I can still easily test my code on a big-endian machine by creating a QEMU PowerPC virtual machine. There&#8217;s already a writeup about trying to install Debian onto a QEMU VM <a href='http://machine-cycle.blogspot.com/2009/05/running-debian-on-qemu-powerpc.html'>here</a>. <a href='http://www.aurel32.net/'>Aurélien Jarno</a> has graciously put together downloadable disk images with Debian preinstalled. If that&#8217;s good enough for your purposes, just go download those! You won&#8217;t need any of the rest of the information on this page.</p>

<p>Unfortunately, I didn&#8217;t want to run stock Debian; my little-endian build machine is running Ubuntu Lucid, and for consistency, I wanted my big-endian VM to be running the same. As it turns out, this also required a fair dose of masochism on my part. There are several issues that you&#8217;ll encounter if you try to do this by hand. Here is my cheat sheet for getting around these issues.</p>

<p>Note that this isn&#8217;t a full step-by-step account of how to install Lucid onto a QEMU VM. For now, I&#8217;m just trying to get my notes down into a more permanent form.</p>

<h2 id='getting_qemu'>Getting QEMU</h2>

<p>Note that I&#8217;m using Ubuntu Lucid as both the host and the guest OS for this virtual machine; if you&#8217;re running QEMU on a non-Ubuntu host, then you can skip this section.</p>

<p>It seems that there&#8217;s a bug with the current QEMU packages in Lucid. If you try to run <code>qemu-system-ppc</code>, you&#8217;ll get an error message about missing the PowerPC BIOS image. Joy.</p>

<p>Easiest way to get around this is to install QEMU from source. Download the latest version from <a href='http://download.savannah.gnu.org/releases/qemu/'>here</a>. Once you&#8217;ve unpacked it, use the following to build:</p>

<pre><code>$ sudo apt-get build-dep qemu
$ ./configure --prefix=/usr/local \
    --enable-sdl --enable-curses --enable-curl \
    --enable-kvm --enable-nptl --enable-uuid \
    --enable-linux-aio --enable-io-thread \
    --audio-drv-list=alsa
$ make
$ sudo make install</code></pre>

<p>The first command is just an easy way to ensure that all of the prerequisite libraries are installed.</p>

<h2 id='booting_the_installation_cd'>Booting the installation CD</h2>

<p>Once you&#8217;ve got a working QEMU installed, you can find the PowerPC Lucid installation CD <a href='http://cdimage.ubuntu.com/ports/releases/10.04/release/'>here</a>. I&#8217;ve decided to use the server installation CD; I don&#8217;t really need (or want) X windows running in the VM.</p>

<p>To install this onto a new VM, it should be as simple as:</p>

<pre><code>$ qemu-img create -f qcow2 ubuntu-ppc.qcow2 10G
$ qemu-system-ppc -m 1024 -hda ubuntu-ppc.qcow2 \
    -cdrom ubuntu-10.04-server-powerpc.iso -boot d</code></pre>

<p>This links up the Ubuntu installation CD on the VM&#8217;s CD-ROM drive, and uses a new disk image for the primary hard disk. Oh, and we make sure to give the VM enough RAM to do its business — the default is a paltry 128MB.</p>

<p>Of course, this doesn&#8217;t work — the Lucid installer suffers from the same problem described <a href='http://mac.linux.be/content/ubuntu-810-installer-fails-detect-cd-rom'>here</a> for the Intrepid installer. Once you get into the installer, the installation program can&#8217;t find the CD-ROM device, and so it can&#8217;t read the installation packages. Unfortunately, the workaround doesn&#8217;t work for Lucid, since it uses a newer Linux kernel that has <a href='http://www.linux.com/archive/feed/33164'>eliminated the <code>ide-scsi</code> module</a>.</p>

<p>So, what do we do? Well, QEMU also allows us to mount a disk image as a USB removable disk, but it won&#8217;t let us boot from USB. We end up having to mount the disk image twice: Once as a virtual CD, so that we can boot into the installer, and once as a virtual USB disk, so that the installer can find the installation packages. The QEMU command line becomes:</p>

<pre><code>$ qemu-system-ppc -m 1024 -hda ubuntu-ppc.qcow2 \
    -cdrom ubuntu-10.04-server-powerpc.iso -boot d \
    -usb -usbdevice disk:ubuntu-10.04-server-powerpc.iso</code></pre>

<p>You won&#8217;t have to manually load the <code>usb-storage</code> module; it gets loaded automatically, and places the USB disk at <code>/dev/sda</code>.</p>

<p>You&#8217;ll still get the error message about not finding the CD; when this happens say &#8220;no&#8221; when it asks whether you need to load a module from a removable disk. Say &#8220;yes&#8221; when it asks if you want to choose a module and device manually; choose &#8220;none&#8221; for the module; then type in <code>/dev/sda</code> as the device location.</p>

<h2 id='corrupt_package_files_on_cd'>Corrupt package files on CD</h2>

<p>Right, so now we have to be good, right? We can start QEMU, we can boot into the installer, and the installer can find all of the packages? Nope! There were several corrupted package files on the CD image I downloaded. If this happens to you, you should certainly try re-downloading the image, to take care of any spurious transmission errors. But if you still end up with some corrupted package files, there are ways around it.</p>

<p>The installer will try to install its initial set of packages using <code>apt-get</code>. If you encounter problems with these stages, you&#8217;ll see some informative error messages on console 4, which is where the installer&#8217;s log output is sent. You can get there by pressing <em>Alt-F4</em> in the VM. (As a warning, don&#8217;t try to shift to console 4 without ensuring that QEMU is grabbing the input. In most window managers, <em>Alt-F4</em> will close the current window, which will just abruptly stop the VM!)</p>

<p>By the time the installer tries to install packages, the VM&#8217;s hard disk will be partitioned and formatted, and so we can drop into a shell as necessary. To do so, shift over to console 2 using <em>Alt-F2</em> — again, make sure that QEMU is grabbing all keyboard and mouse input before switching consoles.</p>

<p>Once you&#8217;re on console 2, you can <code>chroot</code> into the new system as follows:</p>

<pre><code>~ $ mount -o /proc /target/proc
~ $ mount -o /sys /target/sys
~ $ mount -o /dev /target/dev
~ $ chroot /target</code></pre>

<p>At this point, you&#8217;ll be &#8220;inside&#8221; the new installation system, and can run whatever <code>apt-get</code> and <code>dpkg</code> commands are necessary to fix things up.</p>

<p>Most likely, you&#8217;ll see &#8220;hash sum mismatch&#8221; errors, indicating that a package file is corrupt. You need to download the correct version from the archive at <em>ports.ubuntu.com</em>. To do this, you&#8217;ll need a copy of <em>wget</em> installed.</p>

<pre><code>$ apt-get install wget
$ wget -nv http://ports.ubuntu.com/pool/main/PATH_TO_DEB</code></pre>

<p>You&#8217;ll see what to use for the <code>PATH_TO_DEB</code> part in the error message. Once you&#8217;ve downloaded all of the troublesome package files, install them using:</p>

<pre><code>$ dpkg -i *.deb
$ apt-get -f install</code></pre>

<p>Then you can go back into the installer (on console 1) and try to repeat the current step.</p>

<p>Note that things might be broken early enough that you can&#8217;t install <em>wget</em>. If this is the case, how do you download the non-corrupt package file? Luckily, Python was already installed at that point, so you can use the Python standard library to <a href='http://stackoverflow.com/questions/22676/how-do-i-download-a-file-over-http-using-python'>emulate <em>wget</em></a>:</p>

<pre><code>$ python
&gt;&gt;&gt; import urllib2
&gt;&gt;&gt; pkg = urllib2.urlopen(&quot;http://ports.ubuntu.com/BLAH_BLAH&quot;)
&gt;&gt;&gt; output = open(&quot;BLAH_BLAH.deb&quot;, &quot;wb&quot;)
&gt;&gt;&gt; output.write(pkg.read())
&gt;&gt;&gt; output.close()
&gt;&gt;&gt; ^D</code></pre>

<p>You can then install the package as above.</p>

<h2 id='installing_a_bootloader'>Installing a bootloader</h2>

<p>The installer claims that this architecture doesn&#8217;t support a bootloader, so we have to install one by hand. The usual bootloader for PowerPC machines is <code>yaboot</code>; it&#8217;s fair</p>
</div>


<div class="posttags">
  Tags:
  <ul>
    
    <li><a href="/tags/ubuntu/">ubuntu</a></li>
    
  </ul>
</div>


        </div>

        <script type="text/javascript"> Cufon.now(); </script>

        

        <div class="body_separator"></div>

        <div class="body">
          <div id="disqus_thread"></div>

          <script type="text/javascript">
            var disqus_title = "Installing Ubuntu Lucid on a PowerPC QEMU virtual machine";
            var disqus_url = "http://dcreager.net/2010/05/13/powerpc-qemu-lucid/";
          </script>

          <script
             type="text/javascript"
             src="http://disqus.com/forums/dcreager/embed.js">
          </script>
          <noscript>
            <a href="http://dcreager.disqus.com/?url=ref">View the discussion thread.</a>
          </noscript>

          <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
        </div>

        

        </div>

      </div>
    </div>

    <div class="footer">
      <div class="copyright">
        Copyright © 2009-2010, Douglas Creager.  All rights reserved.
      </div>
    </div>
  </body>
</html>

