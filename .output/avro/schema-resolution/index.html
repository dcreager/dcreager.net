<!doctype html>
<html lang="en">
<head>
    <title>
    dcreager.net – Avro schema resolution
  </title>
  <meta name="author" content="Douglas Creager">

    <meta charset="utf-8">

  <meta name="google-site-verification"
        content="7KIoYPNsfdDxIdX1QQ7SM2Nm_nyy13aRlDkzE3wzhhY" />

  <link rel="alternate" type="application/atom+xml"
        title="dcreager.net" href="/atom.xml"/>

  <!-- Bootstrap -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel=stylesheet type=text/css media=screen
        href="/media/vendor/css/bootstrap.min.css">
  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
  <![endif]-->

  <!-- MathJax -->
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      jax: ["input/TeX","output/HTML-CSS"],
      displayAlign: "left",
      displayIndent: "2em"
    });
  </script>
  <script type="text/javascript" async
          src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML">
  </script>

  <!-- Twitter nonsense -->
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@dcreager">
  <meta name="twitter:title"
        content="Avro schema resolution">
  <meta name="twitter:description"
        content="Happy the people whose annals are tiresome">
  <meta name="twitter:image"
        content="https://www.gravatar.com/avatar/04ee3ca11f1ae11c63faa7995dbf1ed7?s=2048">

  <!-- Customizations -->
  <link rel=stylesheet type=text/css media=screen
        href="/media/css/coderay.css">
  <link rel=stylesheet type=text/css media=screen
        href="/media/css/dcreager.css">
  <link rel=stylesheet type=text/css media=screen
        href="https://fonts.googleapis.com/css?family=Oxygen:400,700">

</head>

<body>
  <div class="container">
    <div class="row">
  <div class="col-md-10 col-md-offset-1">
    <nav class="navbar navbar-default" role="navigation">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand logo" href="/"><b>dcreager.net</b></a>
      </div>

      <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
        <ul class="nav navbar-nav navbar-right">
          <li><a href="/about/">About</a></li></li>
          <li><a href="/archive/">Archive</a></li></li>
          <li><a href="https://tinyletter.com/dcreager/">Newsletter</a></li></li>
          <li><a href="/talks/">Talks</a></li></li>
          <li><a href="/publications/">Publications</a></li></li>
        </ul>
      </div><!-- /.navbar-collapse -->
    </nav>
  </div>
</div>

    <div class="row">
      <div class="col-md-8 col-md-offset-2">
        <div class="blog">
          <div class="date">
            2020-03-12
          </div>
          <h1>Avro schema resolution</h1>
          <p>I have always liked <a href="https://avro.apache.org/">Avro</a> better than the other data serialization frameworks
that are out there (<a href="https://developers.google.com/protocol-buffers">Protobuf</a>, <a href="https://thrift.apache.org/">Thrift</a>, <a href="https://json.org/">JSON</a>, <a href="https://msgpack.org/">msgpack</a>, <a href="https://cbor.io/">CBOR</a>,
the list goes on and on).  There are many reasons why, which probably deserves
another post.  But a big one is Avro’s <a href="https://avro.apache.org/docs/current/spec.html#Schema+Resolution">schema resolution</a> rules.  Let’s take
a look at how they work and why they’re useful!</p>

<hr class="jump" />

<p>One of the main problems that data serialization frameworks try to solve is the
<strong><em>backwards compatibility</em></strong> problem.  Your software will naturally evolve over
time, as you fix bugs and add features.  And as part of that evolution, the data
that your program writes or reads will change, too.</p>

<p>So as an example, let’s say we’re creating a program that deals with lists of
countries.  It will need a data type to describe what information it needs to
know about each country, and how to store that information internally.  Let’s
use Pascal, because…well…why not!</p>

<pre class="CodeRay"><code><span class="keyword">record</span>
  IsoCode: <span class="keyword">string</span>[<span class="integer">2</span>];
  Name: <span class="keyword">string</span>[<span class="integer">60</span>];
<span class="keyword">end</span>
</code></pre>

<p>The program needs to read in a list of countries and then do…something…to
it.  (The “something” isn’t really relevant to us today.)  We’re writing this
in, say, 1987, so XML and JSON don’t exist, let alone any of the other
frameworks we’ve mentioned.  We have to roll out own format!  So we go for
simplicity, and say that you provide a text file, with:</p>

<ul>
  <li>each country on a separate line</li>
  <li>the ISO code is the first two characters of the line</li>
  <li>skip any whitespace immediately following</li>
  <li>use the remainder of the line as the country name</li>
</ul>

<pre>
US   United States
CH   China
KZ   Kazakhstan
UK   United Kingdom
TV   Tuvalu
MX   Mexico
EG   Egypt
BZ   Belize
BR   Brazil
</pre>

<p>(Note that’s it’s okay for the country name to include whitespace!  Our file
format definition doesn’t make that ambiguous.)</p>

<p>Back in the old days, when
we would come up with completely custom file formats for each program (text or
binary, doesn’t matter), you had to take this into account explicitly.  If you
just wrote out a bunch of fields, in order, without anything</p>

<p>FAST</p>

<p>A properly tuned Avro library can <em>rip</em> through large files, even if it has to
transform the data by dropping or reordering fields as they’re being processed.
How?  Because your program figures out <em>how</em> to do that transformation for <em>all</em>
of the records in a file <em>once</em>, up front, based on the writer and reader
schemas.  Once it’s done that, it can just blindly follow the transformation
instructions for each record in the file.</p>

<p>By constrast, most other frameworks “self-describe” their data by including
extra information <em>each in value</em>.  This is most obvious in JSON (and its binary
renderings, like msgpack and CBOR), where the field names are included in every
object.  It’s also true in protobufs, where each field in a message has a <a href="https://developers.google.com/protocol-buffers/docs/proto#assigning-field-numbers">field
number</a> that is included in the message’s serialization.
Protobuf message fields can appear in any order (and for <code>optional</code> fields, can
be left out completely), which means that you have to figure out <em>for each
individual value</em> which fields are present, and how they should be deserialized
and transformed into your internal representation.</p>


          <div class="subscribe">
            Stay up to date by subscribing to <a
               href="https://tinyletter.com/dcreager/">my newsletter</a>.
          </div>
        </div>
      </div>
    </div> <!-- /row -->
  </div> <!-- /container -->

    <footer class="copyright">
    <div class="container">
      <p>Copyright © 2009-2020, Douglas Creager.
      All&nbsp;rights&nbsp;reserved.</p>
    </div>
  </footer>

    <script src="//code.jquery.com/jquery.min.js"></script>
  <script src="/media/vendor/js/bootstrap.min.js"></script>

<!-- Google Analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-83885503-1', 'auto');
  ga('send', 'pageview');

</script>

</html>
