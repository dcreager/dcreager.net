<!doctype html>
<html lang="en">
<head>
    <title>
    dcreager.net – Obligations: Resources
  </title>
  <meta name="author" content="Douglas Creager">

    <meta charset="utf-8">

  <meta name="google-site-verification"
        content="7KIoYPNsfdDxIdX1QQ7SM2Nm_nyy13aRlDkzE3wzhhY" />

  <link rel="shortcut icon" href="/media/images/dcreager.ico">

  <link rel="alternate" type="application/atom+xml"
        title="dcreager.net" href="/atom.xml"/>

  <!-- Bootstrap -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel=stylesheet type=text/css media=screen
        href="/media/vendor/css/bootstrap.min.css">
  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
  <![endif]-->

  <!-- MathJax -->
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      jax: ["input/TeX","output/HTML-CSS"],
      displayAlign: "left",
      displayIndent: "2em"
    });
  </script>
  <script type="text/javascript" async
          src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
  </script>

  <!-- Twitter nonsense -->
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@dcreager">
  <meta name="twitter:title"
        content="Obligations: Resources">
  <meta name="twitter:description"
        content="...">
  <meta name="twitter:image"
        content="https://www.gravatar.com/avatar/04ee3ca11f1ae11c63faa7995dbf1ed7?s=2048">

  <!-- Customizations -->
  <link rel=stylesheet type=text/css media=screen
        href="/media/css/coderay.css">
  <link rel=stylesheet type=text/css media=screen
        href="/media/css/dcreager.css">
  <link rel=stylesheet type=text/css media=screen
        href="http://fonts.googleapis.com/css?family=Oxygen:400,700">

</head>

<body>
  <div class="container">
    <div class="row">
  <div class="col-md-10 col-md-offset-1">
    <nav class="navbar navbar-default" role="navigation">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand logo" href="/"><b>dcreager.net</b></a>
      </div>

      <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
        <ul class="nav navbar-nav navbar-right">
          <li><a href="/about/">About</a></li></li>
          <li><a href="/archive/">Archive</a></li></li>
          <li><a href="/talks/">Talks</a></li></li>
          <li><a href="/publications/">Publications</a></li></li>
        </ul>
      </div><!-- /.navbar-collapse -->
    </nav>
  </div>
</div>

    <div class="row">
      <div class="col-md-8 col-md-offset-2">
        <div class="blog">
          <div class="date">2017-08-30</div>
          <h2 class="series">Obligations</h2>
          <h1>Resources</h1>
          
<p>We want to talk about <strong>requirements</strong> and <strong>obligations</strong> in our programming
languages, and how they differ from <strong>permissions</strong> or <strong>possibilities</strong>.  To
start the discussion, we should think about what kinds of requirements we might
want to support.  That will help ground the discussion on how we can implement
those requirements.</p>

<p>The most common example of a requirement in a program involves <strong>resource
management</strong>.  Your program acquires some resource, and we want to ensure that
you clean up that resource when you’re done with it.  C is notorious for being
an “unsafe” language because it provides basically no mechanisms for making
these kinds of guarantees.  To be clear, this does <em>not</em> mean that it’s
impossible to write a safe program in C; it just means that it’s <em>entirely</em> on
you, the programmer, to implement whatever safety features you need, and to do
all of the mental bookkeeping to make sure you didn’t miss anything.  There’s
nothing in C that prevents you from doing either of the following:</p>

<pre class="CodeRay"><code><span class="directive">void</span> not_very_nice(<span class="directive">void</span>) {
    FILE* file = fopen(<span class="string"><span class="delimiter">&quot;</span><span class="content">/usr/share/words</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">r</span><span class="delimiter">&quot;</span></span>);
    <span class="keyword">return</span>;
}

<span class="directive">void</span> also_not_nice(<span class="directive">void</span>) {
    <span class="predefined-type">int</span>* i = malloc(<span class="keyword">sizeof</span>(<span class="predefined-type">int</span>));
    <span class="keyword">return</span>;
}
</code></pre>

<p>So what do other languages do to handle these kinds of situations?</p>

<h5 id="automatic-memory-management">Automatic memory management</h5>

<p>The most common resource that our programs deal with is memory, so it’s no
surprise that we’ve put the most effort into solving this problem for memory
management.</p>

<ul>
  <li>stack allocation</li>
</ul>

<p>ensures that an object is deallocated; typically doesn’t prevent dangling pointer
references</p>

<ul>
  <li>garbage collection</li>
</ul>

<p>a lot of engineering effort goes into the GC; typically the largest part of an
implementation of a VM or language runtime; usually still worth it because of
the time and bugs saved for the end user programmer</p>

<p>This example is a bit of a special case; memory management is so important to so
many programs that most modern languages have baked memory safety <em>into the
language itself</em>.  But what if a library author is trying to create a new kind
of resource that other people can use in their programs?  We can’t update the
language itself (and all of its compilers or interpreters) to support our new
kind of resource.  What options do we have <em>in our programs</em> for defining what
the clean-up behavior should be, and enforcing that it’s executed?</p>

<h5 id="resources-as-objects">Resources as objects</h5>

<ul>
  <li>destructors / RAII</li>
</ul>

<p>the language ensures that the destructor is called just before an object is
deallocated; represent the resource with an object, and put the clean-up logic
in its destructor</p>

<pre><code>std::ifstream
</code></pre>

<p>stack allocation; file is closed
new but no delete; file is not closed!</p>

<pre><code>std::unique_ptr / std::shared_ptr
</code></pre>

<p>modern C++ style is to never call <code>new</code> directly</p>

<ul>
  <li>finalizers are different</li>
</ul>

<p>above only works when you know when an object is going to be destroyed.</p>

<p>The equivalent in a garbage-collected language is called a <strong>finalizer</strong>.</p>

<p>In a garbage collected language, you don’t have guarantees about <em>when</em> an
object will be collected, just that it eventually <em>will</em>.  That can be a problem
when you want to make sure that you clean up your resource as soon as you’re
done using it!</p>

<h5 id="context-managers">Context managers</h5>

<h5 id="stack-like-scoping">Stack-like scoping</h5>

<p>context manager only supports stack-like scoping</p>

<p>C++ move semantics let you do other things</p>

<p>all of this only works for very simple “clean up after yourself” requirements.
more complex patterns aren’t supported</p>

        </div>
      </div>
    </div> <!-- /row -->
  </div> <!-- /container -->

    <footer class="copyright">
    <div class="container">
      <p>Copyright © 2009-2017, Douglas Creager.
      All&nbsp;rights&nbsp;reserved.</p>
    </div>
  </footer>

    <script src="//code.jquery.com/jquery.min.js"></script>
  <script src="/media/vendor/js/bootstrap.min.js"></script>

<!-- Google Analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-83885503-1', 'auto');
  ga('send', 'pageview');

</script>

</html>
